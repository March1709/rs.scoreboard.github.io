<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboSports審判支援ツール</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon"> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* --- 全体スタイル --- */
        body {
            font-family: 'Inter', sans-serif; /* フォント指定 */
            display: flex; /* Flexboxレイアウト */
            flex-direction: column; /* 縦方向の配置 */
            align-items: center; /* 中央揃え（左右） */
            justify-content: flex-start; /* 上寄せ */
            min-height: 100vh; /* 画面全体の高さ */
            background-color: #f0f4f8; /* 背景色 */
            color: #333; /* 基本文字色 */
            margin: 0; /* 外側余白なし */
            padding: 20px; /* 内側余白 */
            box-sizing: border-box; /* paddingとborderをwidth/heightに含める */
        }
        .container {
            background-color: #ffffff; /* コンテナ背景色 */
            padding: 20px; /* コンテナ内側余白 */
            border-radius: 12px; /* 角丸 */
            box-shadow: 0 8px 16px rgba(0,0,0,0.1); /* 影 */
            width: 100%; /* 幅を親要素に合わせる */
            max-width: 700px; /* 最大幅 */
            text-align: center; /* テキスト中央揃え */
        }
        .page { width: 100%; } /* 各ページ共通の幅 */

        /* --- マッチタイトル表示 --- */
        .match-title-display {
            font-size: 2.25rem; /* 文字サイズ (36px) */
            font-weight: bold; /* 太字 */
            color: #111827; /* 文字色 (濃いグレー) */
            margin-bottom: 5px; /* 下余白調整 */
        }
        #currentMatchTeamsDisplay { /* タイマー画面の対戦チーム表示 */
            font-size: 1.5rem; /* 文字サイズを大きく変更 (例: 1.1rem -> 1.5rem) */
            font-weight: 600; /* 少し太く */
            color: #374151; /* gray-700 */
            margin-bottom: 15px;
        }


        /* --- チーム選択エリア --- */
        .team-selection-container {
            margin-bottom: 20px; /* 下余白 */
            padding-bottom: 20px; /* 下パディング */
            border-bottom: 1px solid #e5e7eb; /* 下境界線 */
        }
        
        .team-selection-container h2, .section-title { /* セクションタイトル共通 */
            font-size: 1.25rem; /* 文字サイズ (20px) */
            font-weight: 600; /* 文字の太さ */
            margin-bottom: 10px; /* 下余白 */
            color: #374151; /* 文字色 (グレー) */
        }
        .csv-upload-container { /* CSVアップロードエリア */
            margin-bottom: 20px;
        }
        .csv-upload-container input[type="file"] { /* ファイル選択ボタン */
            margin-bottom: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .team-select-group {
            display: flex; /* Flexboxレイアウト */
            justify-content: space-around; /* 要素間のスペースを均等に配置 */
            align-items: center; /* 中央揃え（上下） */
            gap: 10px; /* 要素間の隙間 */
            margin-bottom: 10px; /* 下余白 */
        }
        .team-select-group label { font-size: 0.9rem; color: #4b5563; } /* ラベルスタイル */
        .team-select-group select { /* プルダウンメニューのスタイル */
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background-color: #fff;
            flex-grow: 1; /* 要素の伸び率 */
        }
        #selectedTeamsDisplay { /* 選択されたチーム表示エリア */
            font-size: 1.1rem; font-weight: bold; color: #1e40af;
            margin-top: 10px; min-height: 25px;
        }

        /* --- タイマー表示 --- */
        .timer-display {
            font-size: 7rem; /* 文字サイズ */
            font-weight: bold; /* 太字 */
            margin-bottom: 20px; /* 下余白 */
            padding: 10px; /* 内側余白 */
            background-color: #eff6ff; /* 背景色 (薄い青) */
            border-radius: 8px; /* 角丸 */
        }
        .timer-paused { color: #f59e0b; } /* 黄色 - 一時停止時 */
        .timer-ended { color: #dc2626; } /* 赤色 - 終了時 */
        .timer-running { color: #1d4ed8; } /* 青色 - 通常時/リセット時 */


        /* --- ボタン共通スタイル --- */
        .button-group {
            display: flex; flex-wrap: wrap; justify-content: center;
            gap: 10px; margin-bottom: 20px;
        }
        .btn {
            padding: 10px 15px; font-size: 1rem; border-radius: 8px;
            border: none; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease; /* アニメーション効果 */
            min-width: 100px; /* 最小幅 */
        }
        .btn:active { transform: scale(0.98); } /* クリック時の縮小効果 */
        .btn-primary { background-color: #2563eb; color: white; } /* プライマリボタン */
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #64748b; color: white; } /* セカンダリボタン */
        .btn-secondary:hover { background-color: #475569; }
        .btn-warning { background-color: #f59e0b; color: white; } /* 警告ボタン */
        .btn-warning:hover { background-color: #d97706; }
        .btn-danger { background-color: #dc2626; color: white; } /* 危険ボタン */
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-success { background-color: #16a34a; color: white; } /* 成功ボタン */
        .btn-success:hover { background-color: #15803d; }
        .btn:disabled { /* 無効状態のボタンスタイル */
            background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed;
        }

        /* --- 各セクションコンテナ --- */
        .status-handling-container, 
        .score-input-page-container, 
        .intermediate-result-page-container, 
        .results-page-container {
            border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 20px;
        }
        .record-display { /* 記録表示エリア（タイマーページ） */
            margin-top: 10px; padding: 10px 15px; background-color: #f3f4f6;
            border-radius: 8px; font-size: 1rem; color: #1f2937;
            min-height: 40px; display: flex; align-items: center; justify-content: center;
        }
        .record-display.recorded { /* 記録が選択された時のスタイル */
            background-color: #d1fae5; color: #065f46; font-weight: bold;
        }
        
        /* --- タイムアウト時情報エリア --- */
        #timeoutInfoContainer { margin-top: 15px; }
        #timeoutMessageDisplay { 
        }
        /* --- 手動終了理由記録エリア --- */
        #manualEndReasonContainer .team-select-group { 
            margin-bottom: 15px; 
        }

        /* --- ボール数入力ページ --- */
        #selectedStatusOnScorePage { 
            font-size: 1.1rem; 
            font-weight: 500; 
            color: #1f2937; 
            background-color: #f3f4f6; 
            padding: 10px 15px;
            border-radius: 8px; margin-bottom: 20px;
        }
        .score-input-area { 
            display: flex; justify-content: space-around; gap: 20px; margin-top: 10px;
        }
        .score-team-section { 
            flex: 1; padding: 15px; border: 1px solid #d1d5db;
            border-radius: 8px; background-color: #f9fafb;
        }
        .score-team-section h3 { 
            font-size: 1.1rem; font-weight: 600; color: #374151; margin-bottom: 10px;
        }
        .score-input-group { margin-bottom: 10px; } 
        .score-input-group label { 
            display: block; font-size: 0.9rem; color: #4b5563; margin-bottom: 5px;
        }
        .score-input-group select { 
            width: 100%; padding: 8px; border-radius: 6px;
            border: 1px solid #d1d5db; box-sizing: border-box;
        }
        .score-input-group select:disabled { 
            background-color: #e5e7eb; 
        }
        .next-match-btn-container button { margin-top: 20px; } 

        /* --- 中間結果表示ページ --- */
        #intermediateMatchResultTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #intermediateMatchResultTable th, #intermediateMatchResultTable td {
            border: 2px solid #000000; 
            padding: 8px 12px; text-align: left;
            font-size: 1.25rem; 
        }
        #intermediateMatchResultTable th { background-color: #f3f4f6; font-weight: 600; }
        #intermediateMatchStatusDisplay { 
             font-size: 1.1rem; font-weight: 500; margin-bottom: 10px;
             padding: 8px; background-color: #eef2ff; border-radius: 6px;
        }
        #intermediateMatchWinnerDisplay { font-size: 1.5rem; font-weight: bold; margin-top: 15px; margin-bottom: 15px; }


        /* --- 結果表示ページ --- */
        .results-table { width: 100%; border-collapse: collapse; margin-top: 15px; } 
        .results-table th, .results-table td { 
            border: 2px solid #000000; 
            padding: 8px 12px; text-align: left;
            font-size: 1.25rem; 
        }
        .results-table th { background-color: #f3f4f6; font-weight: 600; } 
        .results-teams-display { font-size: 1.2rem; font-weight: bold; margin-bottom:15px; } 
        
        .highlight-winner-cell { 
            background-color: #dcfce7; 
        }
        .highlight-draw-cell { 
            background-color: #fee2e2; 
        }

        #summaryStatsContainer { 
            margin-top: 30px;
            text-align: left;
        }
        .summary-table { 
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .summary-table th, .summary-table td { 
            border: 2px solid #000000; 
            padding: 8px;
            text-align: center;
            font-size: 1.1rem;
        }
        .summary-table th { 
            background-color: #e9ecef;
        }
        .overall-winner-row td { 
            background-color: #a7f3d0; 
            font-weight: bold;
        }
        .overall-draw-team-name { 
             background-color: #fecaca; 
             font-weight: bold;
        }
        /* --- 確認モーダル --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; 
        }
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around; 
            margin-top: 20px;
        }


        /* --- 非表示用ユーティリティクラス --- */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-2 text-gray-800">RoboSports審判支援ツール</h1>
        <button id="fullResetButton" class="btn btn-danger mb-4">全体リセット</button>

        <div id="universalTeamSelectionPage" class="page">
            </div>

        <div id="matchPlayPage" class="page hidden">
            <div id="currentMatchDisplay" class="match-title-display">第Xマッチ</div>
            <div id="currentMatchTeamsDisplay" class="text-lg font-medium text-gray-700 mb-4">審判左手 vs 審判右手</div>
            <div id="timerDisplay" class="timer-display timer-running">
                02:00
            </div>

            <div id="timerControlsPreStart" class="button-group">
                <button id="startButton" class="btn btn-primary">開始</button>
            </div>
            <div id="timerControlsActive" class="button-group hidden">
                <button id="startButtonActive" class="btn btn-primary" disabled>開始</button>
                <button id="pauseButton" class="btn btn-secondary">一時停止</button>
                <button id="endMatchButton" class="btn btn-danger">試合手動終了(理由記録へ)</button>
                <button id="resetMatchTimerButton" class="btn btn-warning" disabled>このマッチのタイマーリセット</button>
            </div>
            
            <div class="status-handling-container">
                <div id="manualEndReasonContainer" class="hidden">
                    <h2 class="section-title">終了理由</h2> 
                    <div class="team-select-group">
                        <label for="endedByTeamSelect" class="mr-2">対象チーム:</label>
                        <select id="endedByTeamSelect" class="flex-grow"></select>
                    </div>
                    <div class="team-select-group mt-3">
                        <label for="endReasonSelect" class="mr-2">理由:</label>
                        <select id="endReasonSelect" class="flex-grow">
                            </select>
                    </div>
                    <button id="manualEndProceedToScoreButton" class="btn btn-primary mt-4" disabled>ボール数入力へ進む</button>
                </div>

                <div id="timeoutInfoContainer" class="hidden">
                    <div id="timeoutMessageDisplay"></div> 
                    <button id="timeoutProceedToScoreButton" class="btn btn-primary">ボール数入力へ進む</button>
                </div>
            </div>
            <div id="recordDisplayOnTimerPage" class="record-display">記録待機中...</div>
        </div>

        <div id="scoreInputPage" class="page hidden">
            </div>

        <div id="intermediateResultPage" class="page hidden">
            <div class="intermediate-result-page-container">
                <h2 id="intermediateResultTitle" class="section-title match-title-display">第Xマッチ 結果</h2>
                <div id="intermediateMatchTeams" class="results-teams-display">チームA vs チームB</div>
                <div id="intermediateMatchStatusDisplay" class="record-display my-3">リザルト: 未記録</div> 
                <table id="intermediateMatchResultTable" class="results-table">
                    <thead>
                        <tr>
                            <th>チーム</th> 
                            <th>オレンジ</th>
                            <th>紫</th>
                            <th>得点</th>
                        </tr>
                    </thead>
                    <tbody id="intermediateMatchResultTableBody">
                        </tbody>
                </table>
                <div id="intermediateMatchWinnerDisplay" class="font-bold text-xl my-4">勝者: チームX</div>
                <button id="goToNextStepButton" class="btn btn-primary">次へ進む</button>
            </div>
        </div>


        <div id="resultsPage" class="page hidden">
            <div class="results-page-container">
                <h2 class="section-title match-title-display">試合結果</h2>
                <div id="resultsTeamsDisplay" class="results-teams-display">チームA vs チームB</div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th rowspan="2">マッチ</th>
                            <th rowspan="2">リザルト</th> 
                            <th colspan="3" id="resultsHeaderTeamA">チームA</th> 
                            <th colspan="3" id="resultsHeaderTeamB">チームB</th> 
                        </tr>
                        <tr>
                            <th>オレンジ</th>
                            <th>紫</th>
                            <th>得点</th>
                            <th>オレンジ</th>
                            <th>紫</th>
                            <th>得点</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        </tbody>
                </table>
                <div id="summaryStatsContainer">
                    </div>
                <div id="overallWinnerDisplay" class="mt-4 font-bold text-2xl"></div>
                <button id="startNewGameButton" class="btn btn-success mt-4">新しい試合を開始</button>
            </div>
        </div>

        <div id="confirmationModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 id="confirmationModalMessage">試合を終了しますか？</h3>
                <div class="modal-buttons">
                    <button id="confirmEndMatchButton" class="btn btn-danger">終了する</button>
                    <button id="cancelEndMatchButton" class="btn btn-secondary">継続する</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const universalTeamSelectionPage = document.getElementById('universalTeamSelectionPage');
        const matchPlayPage = document.getElementById('matchPlayPage');
        const scoreInputPage = document.getElementById('scoreInputPage');
        const intermediateResultPage = document.getElementById('intermediateResultPage'); 
        const resultsPage = document.getElementById('resultsPage');
        const confirmationModal = document.getElementById('confirmationModal'); 
        const confirmEndMatchButton = document.getElementById('confirmEndMatchButton');
        const cancelEndMatchButton = document.getElementById('cancelEndMatchButton');
        
        let csvFileInput = null; 
        let loadCsvButton = null; 
        let teamSelectDropdownsContainer = null; 
        let teamASelect = null; 
        let teamBSelect = null; 
        let selectedTeamsDisplay = null; 
        let confirmTeamsButton = null; 
        
        const fullResetButton = document.getElementById('fullResetButton');
        const currentMatchDisplay = document.getElementById('currentMatchDisplay');
        const currentMatchTeamsDisplay = document.getElementById('currentMatchTeamsDisplay'); 
        const timerDisplay = document.getElementById('timerDisplay');
        
        const timerControlsPreStart = document.getElementById('timerControlsPreStart');
        const timerControlsActive = document.getElementById('timerControlsActive');
        const startButton = document.getElementById('startButton'); 
        const startButtonActive = document.getElementById('startButtonActive'); 
        const pauseButton = document.getElementById('pauseButton');
        const resetMatchTimerButton = document.getElementById('resetMatchTimerButton');
        const endMatchButton = document.getElementById('endMatchButton'); 
        
        const manualEndReasonContainer = document.getElementById('manualEndReasonContainer');
        const endedByTeamSelect = document.getElementById('endedByTeamSelect');
        const endReasonSelect = document.getElementById('endReasonSelect');
        const manualEndProceedToScoreButton = document.getElementById('manualEndProceedToScoreButton');

        const timeoutInfoContainer = document.getElementById('timeoutInfoContainer'); 
        const timeoutMessageDisplay = document.getElementById('timeoutMessageDisplay'); 
        const timeoutProceedToScoreButton = document.getElementById('timeoutProceedToScoreButton'); 
        const recordDisplayOnTimerPage = document.getElementById('recordDisplayOnTimerPage');

        let scoreTeamAName = null; 
        let teamAOrangeBallsSelect = null; 
        let teamAPurpleBallsSelect = null; 
        let scoreTeamBName = null; 
        let teamBOrangeBallsSelect = null; 
        let teamBPurpleBallsSelect = null; 
        let proceedToNextPhaseButton = null;
        let backToMatchTimerButton = null;
        let currentMatchScoreTitle = null;
        let selectedStatusOnScorePage = null;

        // Intermediate Result Page Elements
        let intermediateResultTitle = null;
        let intermediateMatchTeams = null;
        let intermediateMatchStatusDisplay = null; 
        let intermediateMatchResultTableBody = null;
        let intermediateMatchWinnerDisplay = null;
        let goToNextStepButton = null;

        let resultsTeamsDisplay = null;
        let resultsHeaderTeamA = null; 
        let resultsHeaderTeamB = null; 
        let resultsTableBody = null;
        let startNewGameButton = null;
        let summaryStatsContainer = null; 
        let overallWinnerDisplay = null; 


        // --- Game State ---
        const TOTAL_MATCHES = 3;
        const INITIAL_TIME_SECONDS = 2 * 60; 
        const MAX_ORANGE_BALLS = 8;
        const MAX_PURPLE_BALLS = 2;

        let currentMatchNumber = 1;
        let timeLeft = INITIAL_TIME_SECONDS;
        let timerInterval = null;
        let timerRunning = false;
        
        let confirmedTeamA = ""; 
        let confirmedTeamB = "";
        let confirmedTeamADisplay = ""; 
        let confirmedTeamBDisplay = "";
        let teamListFromCsv = []; 
        let matchesData = []; 

        const PENALTY_FIXED_SCORE_REASONS = [ 
            "レッドゾーン接触(6.27)",
            "故意のロボット接触(6.28)",
            "相手フィールド接触(6.29)",
            "分離パーツ接触(6.23)",
            "試合開始後10秒ロボット不動(6.20)",
            "両ロボット除去(6.21)", 
            "両ロボット脱走(6.32.6)", 
            "ロボットのサイズ超過(6.32.3)",
            "フィールド・ボール破壊(6.32.7・6.32.8)",
            "選手のロボット接触(6.33)",
            "選手のフィールド接触(6.32.5)"
        ];
        // FOUL_COUNTING_REASONS は、特定のペナルティ理由が「違反」としてカウントされることを定義します。
        const FOUL_COUNTING_REASONS = [...PENALTY_FIXED_SCORE_REASONS];

        // --- Audio Setup (Tone.js) ---
        let synth = null;
        const BEEP_VOLUME = 0; 

        function initializeAudio() {
            if (!synth && typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    console.log("AudioContext started by Tone.js");
                    synth = new Tone.Synth({ volume: BEEP_VOLUME }).toDestination();
                }).catch(e => {
                    console.error("Error starting Tone.js AudioContext:", e);
                });
            } else if (!synth && typeof Tone !== 'undefined') {
                 synth = new Tone.Synth({ volume: BEEP_VOLUME }).toDestination();
            }
        }
        document.body.addEventListener('click', initializeAudio, { once: true });


        function playShortBeep() {
            initializeAudio(); 
            if (synth && Tone.context.state === 'running') {
                try {
                    synth.triggerAttackRelease("G5", "0.1", Tone.now()); 
                } catch (e) {
                    console.error("Error playing short beep:", e);
                }
            }
        }

        function playLongBeep() {
            initializeAudio();
            if (synth && Tone.context.state === 'running') {
                 try {
                    synth.triggerAttackRelease("E5", "1.5", Tone.now()); 
                } catch (e) {
                    console.error("Error playing long beep:", e);
                }
            }
        }


        // --- Page Navigation & Display Control ---
        function showPage(pageElement) {
            [universalTeamSelectionPage, matchPlayPage, scoreInputPage, intermediateResultPage, resultsPage].forEach(p => {
                if (p) p.classList.add('hidden');
            });
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
        }

        function populateSelectWithOptions(selectElement, max, includeDefault = true, optionsArray = null) {
            if (!selectElement) return; 
            selectElement.innerHTML = ''; 
            if (includeDefault) {
                const defaultOption = new Option("選択", ""); 
                selectElement.add(defaultOption);
            }
            if (optionsArray) {
                optionsArray.forEach(opt => {
                    if (typeof opt === 'object' && opt.hasOwnProperty('value') && opt.hasOwnProperty('text')) { 
                        selectElement.add(new Option(opt.text, opt.value));
                    } else if (typeof opt === 'string') { 
                        selectElement.add(new Option(opt, opt));
                    }
                });
            } else { 
                for (let i = 0; i <= max; i++) {
                    selectElement.add(new Option(i, i));
                }
            }
        }
        
        function initializeScoreSelects() {
            populateSelectWithOptions(teamAOrangeBallsSelect, MAX_ORANGE_BALLS, true);
            populateSelectWithOptions(teamBOrangeBallsSelect, MAX_ORANGE_BALLS, true);
            populateSelectWithOptions(teamAPurpleBallsSelect, MAX_PURPLE_BALLS, true);
            populateSelectWithOptions(teamBPurpleBallsSelect, MAX_PURPLE_BALLS, true);
        }
        
        function initializeEndReasonSelects() {
            const endReasons = [
                "コールド", 
                ...PENALTY_FIXED_SCORE_REASONS,
                "事故のロボット接触(6.28)", 
                "全ロボット行動不能(6.32.9)", 
                "オレンジボール5個以上10秒保持(6.30)" 
            ];
            const uniqueEndReasons = [...new Set(endReasons)]; 

            populateSelectWithOptions(endReasonSelect, 0, true, uniqueEndReasons);
            if (endedByTeamSelect) endedByTeamSelect.value = "";
            if (endReasonSelect) endReasonSelect.value = "";
        }


        // --- Initialization and Resets ---
        function initializeTeamSelectionUI() { 
            teamASelect = document.getElementById('teamASelectInternal');
            teamBSelect = document.getElementById('teamBSelectInternal');
            selectedTeamsDisplay = document.getElementById('selectedTeamsDisplayInternal');
            confirmTeamsButton = document.getElementById('confirmTeamsButtonInternal');

            if (!teamASelect || !teamBSelect || !selectedTeamsDisplay || !confirmTeamsButton) {
                console.error("Team selection dropdown elements not found.");
                return;
            }
            
            populateSelectWithOptions(teamASelect, 0, true, teamListFromCsv); 
            populateSelectWithOptions(teamBSelect, 0, true, teamListFromCsv);

            selectedTeamsDisplay.textContent = "チームを選択してください";
            confirmTeamsButton.disabled = true;
            teamASelect.disabled = false;
            teamBSelect.disabled = false;
            if(teamSelectDropdownsContainer) teamSelectDropdownsContainer.classList.remove('hidden');


             teamASelect.addEventListener('change', handleTeamSelectionChange);
             teamBSelect.addEventListener('change', handleTeamSelectionChange);
             confirmTeamsButton.addEventListener('click', () => {
                const teamAOption = teamASelect.options[teamASelect.selectedIndex];
                const teamBOption = teamBSelect.options[teamBSelect.selectedIndex];

                confirmedTeamA = teamAOption.value; 
                confirmedTeamADisplay = teamAOption.text; 
                confirmedTeamB = teamBOption.value;
                confirmedTeamBDisplay = teamBOption.text;

                teamASelect.disabled = true; 
                teamBSelect.disabled = true;
                confirmTeamsButton.disabled = true; 
                
                if(resultsHeaderTeamA) resultsHeaderTeamA.textContent = confirmedTeamADisplay;
                if(resultsHeaderTeamB) resultsHeaderTeamB.textContent = confirmedTeamBDisplay;

                setupNewMatch(1);
            });
        }
        
        function resetMatchSpecificUIData() {
            timeLeft = INITIAL_TIME_SECONDS;
            timerRunning = false;

            if (timerInterval) clearInterval(timerInterval);
            if(timerDisplay) {
                timerDisplay.textContent = formatTime(timeLeft);
                timerDisplay.classList.remove('timer-paused', 'timer-ended');
                timerDisplay.classList.add('timer-running'); 
            }
            
            if(timerControlsPreStart) timerControlsPreStart.classList.remove('hidden');
            if(timerControlsActive) timerControlsActive.classList.add('hidden');
            if(startButton) startButton.disabled = false; 
            if(startButtonActive) startButtonActive.disabled = true; 
            if(pauseButton) pauseButton.disabled = true;
            if(endMatchButton) endMatchButton.disabled = false; 
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
            
            if(manualEndReasonContainer) manualEndReasonContainer.classList.add('hidden'); 
            if(timeoutInfoContainer) timeoutInfoContainer.classList.add('hidden'); 
            initializeEndReasonSelects(); 
            if(manualEndProceedToScoreButton) manualEndProceedToScoreButton.disabled = true;

            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.textContent = "記録待機中...";
            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.classList.remove('recorded');

            [teamAOrangeBallsSelect, teamBOrangeBallsSelect, teamAPurpleBallsSelect, teamBPurpleBallsSelect].forEach(sel => {
                if (sel) {
                    sel.value = "-1"; 
                    sel.disabled = true; 
                }
            });
            if(proceedToNextPhaseButton) proceedToNextPhaseButton.disabled = true;
        }

        function setupNewMatch(matchNum) {
            currentMatchNumber = matchNum;
            if(currentMatchDisplay) currentMatchDisplay.textContent = `第${currentMatchNumber}マッチ`;
            if(currentMatchTeamsDisplay) currentMatchTeamsDisplay.textContent = `${confirmedTeamADisplay} vs ${confirmedTeamBDisplay}`; 
            if(currentMatchScoreTitle) currentMatchScoreTitle.textContent = `第${currentMatchNumber}マッチ ボール数入力`; 
            resetMatchSpecificUIData();
            showPage(matchPlayPage);
        }

        function fullApplicationReset() { 
            currentMatchNumber = 1;
            matchesData = [];
            confirmedTeamA = "";
            confirmedTeamB = "";
            confirmedTeamADisplay = "";
            confirmedTeamBDisplay = "";
            teamListFromCsv = []; 

            if(csvFileInput) csvFileInput.value = ""; 
            const csvUploadContainer = document.getElementById('csvUploadContainer'); 
            if (csvUploadContainer) {
                 csvUploadContainer.classList.remove('hidden');
            }
            if(teamSelectDropdownsContainer) teamSelectDropdownsContainer.classList.add('hidden'); 
            
            resetMatchSpecificUIData(); 
            initializeScoreSelects(); 
            initializeEndReasonSelects();

            showPage(universalTeamSelectionPage);
        }

        function resetForNewGameWithSameCsv() { 
            currentMatchNumber = 1;
            matchesData = [];
            
            resetMatchSpecificUIData();
            initializeScoreSelects(); 
            initializeEndReasonSelects(); 

            const csvUploadContainer = document.getElementById('csvUploadContainer');
            if (universalTeamSelectionPage && csvUploadContainer && teamSelectDropdownsContainer) {
                csvUploadContainer.classList.add('hidden'); 
                initializeTeamSelectionUI(); 
                showPage(universalTeamSelectionPage);
            } else {
                console.error("Cannot reset to team selection: universal page or containers not found.");
                fullApplicationReset(); 
            }
        }


        // --- Team Selection Logic ---
        function handleTeamSelectionChange() {
            if (!teamASelect || !teamBSelect || !selectedTeamsDisplay || !confirmTeamsButton) return;
            const teamAVal = teamASelect.value; 
            const teamBVal = teamBSelect.value;
            const teamAText = teamASelect.options[teamASelect.selectedIndex].text;
            const teamBText = teamBSelect.options[teamBSelect.selectedIndex].text;


            if (teamAVal && teamBVal) {
                if (teamAVal === teamBVal) {
                    selectedTeamsDisplay.textContent = "異なるチームを選択してください";
                    selectedTeamsDisplay.style.color = "red";
                    confirmTeamsButton.disabled = true;
                } else {
                    selectedTeamsDisplay.textContent = `${teamAText} vs ${teamBText}`;
                    selectedTeamsDisplay.style.color = "#1e40af";
                    confirmTeamsButton.disabled = false;
                }
            } else {
                selectedTeamsDisplay.textContent = "両方のチームを選択してください";
                selectedTeamsDisplay.style.color = "orange";
                confirmTeamsButton.disabled = true;
            }
        }

        // --- Timer Logic ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function startTimer() {
            if (timerRunning || timeLeft === 0) return;
            playLongBeep(); 
            timerRunning = true;
            
            if(timerControlsPreStart) timerControlsPreStart.classList.add('hidden');
            if(timerControlsActive) timerControlsActive.classList.remove('hidden');
            if(startButtonActive) startButtonActive.disabled = true; 
            if(pauseButton) pauseButton.disabled = false;
            if(endMatchButton) endMatchButton.disabled = false; 
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
            if(timerDisplay) {
                timerDisplay.classList.remove('timer-paused', 'timer-ended');
                timerDisplay.classList.add('timer-running');
            }


            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.textContent = "試合中...";
            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.classList.remove('recorded');
            if(manualEndReasonContainer) manualEndReasonContainer.classList.add('hidden'); 
            if(timeoutInfoContainer) timeoutInfoContainer.classList.add('hidden'); 

            timerInterval = setInterval(() => {
                timeLeft--;
                if(timerDisplay) timerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerRunning = false;
                    timeLeft = 0;
                    if(timerDisplay) {
                        timerDisplay.textContent = formatTime(timeLeft);
                        timerDisplay.classList.remove('timer-running', 'timer-paused');
                        timerDisplay.classList.add('timer-ended');
                    }
                    playLongBeep(); 
                    handleMatchEnd(true); 
                }
            }, 1000);
        }

        function pauseTimer() {
            if (!timerRunning) return;
            playShortBeep(); 
            clearInterval(timerInterval);
            timerRunning = false;
            if(startButtonActive) startButtonActive.disabled = false; 
            if(pauseButton) pauseButton.disabled = true;
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = false; 
            if(timerDisplay) {
                timerDisplay.classList.remove('timer-running', 'timer-ended');
                timerDisplay.classList.add('timer-paused');
            }
            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.textContent = "一時停止中";
        }

        if(resetMatchTimerButton) resetMatchTimerButton.addEventListener('click', () => {
            playShortBeep(); 
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = INITIAL_TIME_SECONDS;
            timerRunning = false; 
            if(timerDisplay) {
                timerDisplay.textContent = formatTime(timeLeft);
                timerDisplay.classList.remove('timer-paused', 'timer-ended');
                timerDisplay.classList.add('timer-running');
            }
            
            if(timerControlsActive && !timerControlsActive.classList.contains('hidden')) {
                if(startButtonActive) startButtonActive.disabled = false; 
                if(pauseButton) pauseButton.disabled = true; 
                if(endMatchButton) endMatchButton.disabled = false; 
                if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
            }
            
            if(manualEndReasonContainer) manualEndReasonContainer.classList.add('hidden');
            if(timeoutInfoContainer) timeoutInfoContainer.classList.add('hidden');
            initializeEndReasonSelects();
            if(manualEndProceedToScoreButton) manualEndProceedToScoreButton.disabled = true;
            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.textContent = "記録待機中...";
            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.classList.remove('recorded');
        });

        if(endMatchButton) endMatchButton.addEventListener('click', () => { 
            if(confirmationModal) confirmationModal.classList.remove('hidden');
        });

        if(confirmEndMatchButton) confirmEndMatchButton.addEventListener('click', () => {
            playLongBeep(); 
            if(confirmationModal) confirmationModal.classList.add('hidden');
            if (timerInterval) clearInterval(timerInterval); 
            timerRunning = false; 
            if(timerDisplay) {
                timerDisplay.classList.remove('timer-running', 'timer-paused');
                timerDisplay.classList.add('timer-ended');
            }
            handleMatchEnd(false); 
        });

        if(cancelEndMatchButton) cancelEndMatchButton.addEventListener('click', () => {
            if(confirmationModal) confirmationModal.classList.add('hidden');
        });
        
        function handleMatchEnd(isTimeout) {
            if(timerControlsPreStart) timerControlsPreStart.classList.add('hidden'); 
            if(timerControlsActive) timerControlsActive.classList.remove('hidden'); 
            if(startButtonActive) startButtonActive.disabled = true; 
            if(pauseButton) pauseButton.disabled = true;
            if(endMatchButton) endMatchButton.disabled = true; 
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
            if(timerDisplay) { 
                timerDisplay.classList.remove('timer-running', 'timer-paused');
                timerDisplay.classList.add('timer-ended');
            }


            if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
            matchesData[currentMatchNumber - 1].isColdGame = false; 
            matchesData[currentMatchNumber - 1].isPenaltyFixedScore = false; 
            matchesData[currentMatchNumber - 1].penaltyLosingTeam = ""; 
            matchesData[currentMatchNumber - 1].matchWinner = null;


            if (isTimeout) {
                if(manualEndReasonContainer) manualEndReasonContainer.classList.add('hidden'); 
                if(timeoutInfoContainer) timeoutInfoContainer.classList.remove('hidden'); 
                if(timeoutMessageDisplay) timeoutMessageDisplay.textContent = ""; 
                if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.textContent = "試合終了！ボール数入力へ進んでください。"; 
                if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.classList.add('recorded'); 
                matchesData[currentMatchNumber - 1].status = "タイムアップ"; 
            } else {
                if(manualEndReasonContainer) manualEndReasonContainer.classList.remove('hidden');
                if(timeoutInfoContainer) timeoutInfoContainer.classList.add('hidden');
                populateSelectWithOptions(endedByTeamSelect, 0, true, [ 
                    {text: confirmedTeamADisplay, value: confirmedTeamA},
                    {text: confirmedTeamBDisplay, value: confirmedTeamB}
                ]);
                initializeEndReasonSelects(); 
                if(manualEndProceedToScoreButton) manualEndProceedToScoreButton.disabled = true;

                if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.textContent = "試合手動終了。終了理由を選択してください。";
                if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.classList.remove('recorded');
            }
        }
        
        function setupScorePageUI() { 
            const currentMatchRecord = matchesData[currentMatchNumber - 1] || {};
            if(selectedStatusOnScorePage) {
                 selectedStatusOnScorePage.textContent = `リザルト: ${currentMatchRecord.status || "未記録"}`;
            }
            const scoreInputTitleElement = document.querySelector('#scoreInputPage .section-title'); 
            if(scoreInputTitleElement) scoreInputTitleElement.classList.add('hidden'); 

            if (currentMatchNumber === 2) {
                if(scoreTeamAName) scoreTeamAName.textContent = confirmedTeamBDisplay; 
                if(scoreTeamBName) scoreTeamBName.textContent = confirmedTeamADisplay; 
            } else {
                if(scoreTeamAName) scoreTeamAName.textContent = confirmedTeamADisplay; 
                if(scoreTeamBName) scoreTeamBName.textContent = confirmedTeamBDisplay; 
            }

            [teamAOrangeBallsSelect, teamAPurpleBallsSelect, teamBOrangeBallsSelect, teamBPurpleBallsSelect].forEach(sel => {
                if(sel) {
                    sel.disabled = false;
                    sel.value = "-1"; 
                }
            });

            if (currentMatchRecord.isColdGame) {
                const losingTeamValue = currentMatchRecord.penaltyLosingTeam; 
                let uiLosingOrangeSelect, uiWinningOrangeSelect;

                if (currentMatchNumber === 2) { 
                    uiLosingOrangeSelect = (losingTeamValue === confirmedTeamB) ? teamAOrangeBallsSelect : teamBOrangeBallsSelect;
                    uiWinningOrangeSelect = (losingTeamValue === confirmedTeamB) ? teamBOrangeBallsSelect : teamAOrangeBallsSelect;
                } else { 
                    uiLosingOrangeSelect = (losingTeamValue === confirmedTeamA) ? teamAOrangeBallsSelect : teamBOrangeBallsSelect;
                    uiWinningOrangeSelect = (losingTeamValue === confirmedTeamA) ? teamBOrangeBallsSelect : teamAOrangeBallsSelect;
                }

                if (uiLosingOrangeSelect) {
                    uiLosingOrangeSelect.value = "0";
                    uiLosingOrangeSelect.disabled = true;
                }
                if (uiWinningOrangeSelect) {
                    uiWinningOrangeSelect.value = String(MAX_ORANGE_BALLS);
                    uiWinningOrangeSelect.disabled = true;
                }
            }
            
            if(proceedToNextPhaseButton) {
                 proceedToNextPhaseButton.disabled = true;
                 proceedToNextPhaseButton.textContent = "確定"; 
            }
            checkIfScoresAreComplete(); 
            showPage(scoreInputPage);
        }

        if(timeoutProceedToScoreButton) timeoutProceedToScoreButton.addEventListener('click', () => {
            if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
            // status is already set to "タイムアップ" in handleMatchEnd
            matchesData[currentMatchNumber - 1].isColdGame = false; 
            matchesData[currentMatchNumber - 1].isPenaltyFixedScore = false;
            setupScorePageUI(); 
        });

        if(manualEndProceedToScoreButton) manualEndProceedToScoreButton.addEventListener('click', () => {
            const teamValue = endedByTeamSelect.value; 
            const teamText = endedByTeamSelect.options[endedByTeamSelect.selectedIndex].text; 
            const reason = endReasonSelect.value;
            const statusText = `${teamText} - ${reason}`; 
            
            const isCold = (reason === "コールド");
            const isPenalty = PENALTY_FIXED_SCORE_REASONS.includes(reason);

            if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
            matchesData[currentMatchNumber - 1].status = statusText;
            matchesData[currentMatchNumber - 1].isColdGame = isCold;
            matchesData[currentMatchNumber - 1].isPenaltyFixedScore = isPenalty;
            matchesData[currentMatchNumber - 1].penaltyLosingTeam = (isCold || isPenalty) ? teamValue : ""; 

            setupScorePageUI(); 
        });

        function checkManualEndReasonSelection() {
            if (endedByTeamSelect && endReasonSelect && endedByTeamSelect.value && endReasonSelect.value) {
                if(manualEndProceedToScoreButton) manualEndProceedToScoreButton.disabled = false;
            } else {
                if(manualEndProceedToScoreButton) manualEndProceedToScoreButton.disabled = true;
            }
        }
        if(endedByTeamSelect) endedByTeamSelect.addEventListener('change', checkManualEndReasonSelection);
        if(endReasonSelect) endReasonSelect.addEventListener('change', checkManualEndReasonSelection);
        
        if(backToMatchTimerButton) backToMatchTimerButton.addEventListener('click', () => {
            showPage(matchPlayPage);
            if (!timerRunning) { 
                if(timerControlsActive && !timerControlsActive.classList.contains('hidden')) {
                    if(timeLeft > 0) { 
                        if(startButtonActive) startButtonActive.disabled = false;
                        if(pauseButton) pauseButton.disabled = true;
                        if(endMatchButton) endMatchButton.disabled = false;
                        if(resetMatchTimerButton) resetMatchTimerButton.disabled = !pauseButton.disabled; 
                    } else { 
                        if(startButtonActive) startButtonActive.disabled = true;
                        if(pauseButton) pauseButton.disabled = true;
                        if(endMatchButton) endMatchButton.disabled = true;
                        if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
                    }
                }
                if (manualEndReasonContainer && !manualEndReasonContainer.classList.contains('hidden')) {
                } else if (timeoutInfoContainer && !timeoutInfoContainer.classList.contains('hidden')) {
                } else {
                    if(manualEndReasonContainer) manualEndReasonContainer.classList.add('hidden');
                    if(timeoutInfoContainer) timeoutInfoContainer.classList.add('hidden');
                }
            }
        });


        // --- Score Input Logic (Selects) ---
        function handleScoreSelectChange(sourceSelect, targetSelect, maxTotal) {
            if (!sourceSelect || !targetSelect) return;
            if (!sourceSelect.disabled) { 
                const sourceValue = parseInt(sourceSelect.value);
                if (sourceValue >= 0 && sourceValue <= maxTotal) { 
                    targetSelect.value = maxTotal - sourceValue;
                } else { 
                    targetSelect.value = "-1"; 
                }
            }
            checkIfScoresAreComplete();
        }

        function checkIfScoresAreComplete() {
            const currentMatchRecord = matchesData[currentMatchNumber - 1] || {};
            const valuesToValidate = [];

            if (currentMatchRecord.isColdGame) { 
                valuesToValidate.push(teamAPurpleBallsSelect?.value, teamBPurpleBallsSelect?.value);
            } else { 
                valuesToValidate.push(
                    teamAOrangeBallsSelect?.value, teamAPurpleBallsSelect?.value,
                    teamBOrangeBallsSelect?.value, teamBPurpleBallsSelect?.value
                );
            }
            
            const allSelected = valuesToValidate.every(val => val && parseInt(val) !== -1 && val !== "");
            if(proceedToNextPhaseButton) proceedToNextPhaseButton.disabled = !allSelected;

            if(allSelected) { 
                if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
                
                let uiOrangeLeftVal = parseInt(teamAOrangeBallsSelect.value);
                let uiPurpleLeftVal = parseInt(teamAPurpleBallsSelect.value);
                let uiOrangeRightVal = parseInt(teamBOrangeBallsSelect.value);
                let uiPurpleRightVal = parseInt(teamBPurpleBallsSelect.value);

                if (currentMatchNumber === 2) {
                    matchesData[currentMatchNumber - 1].teamB_Orange = uiOrangeLeftVal;
                    matchesData[currentMatchNumber - 1].teamB_Purple = uiPurpleLeftVal;
                    matchesData[currentMatchNumber - 1].teamA_Orange = uiOrangeRightVal;
                    matchesData[currentMatchNumber - 1].teamA_Purple = uiPurpleRightVal;
                } else {
                    matchesData[currentMatchNumber - 1].teamA_Orange = uiOrangeLeftVal;
                    matchesData[currentMatchNumber - 1].teamA_Purple = uiPurpleLeftVal;
                    matchesData[currentMatchNumber - 1].teamB_Orange = uiOrangeRightVal;
                    matchesData[currentMatchNumber - 1].teamB_Purple = uiPurpleRightVal;
                }
            }
        }

        if(teamAOrangeBallsSelect) teamAOrangeBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamAOrangeBallsSelect, teamBOrangeBallsSelect, MAX_ORANGE_BALLS));
        if(teamBOrangeBallsSelect) teamBOrangeBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamBOrangeBallsSelect, teamAOrangeBallsSelect, MAX_ORANGE_BALLS));
        if(teamAPurpleBallsSelect) teamAPurpleBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamAPurpleBallsSelect, teamBPurpleBallsSelect, MAX_PURPLE_BALLS));
        if(teamBPurpleBallsSelect) teamBPurpleBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamBPurpleBallsSelect, teamAPurpleBallsSelect, MAX_PURPLE_BALLS));

        if(proceedToNextPhaseButton) proceedToNextPhaseButton.addEventListener('click', () => {
            displayIntermediateResult(currentMatchNumber - 1);
        });

        // --- Intermediate Result Page Logic ---
        function displayIntermediateResult(matchIndex) {
            const match = matchesData[matchIndex];
            if (!match || !intermediateResultPage) return;

            if(intermediateResultTitle) intermediateResultTitle.textContent = `第${matchIndex + 1}マッチ 結果`;
            if(intermediateMatchTeams) intermediateMatchTeams.textContent = `${confirmedTeamADisplay} vs ${confirmedTeamBDisplay}`;
            if(intermediateMatchStatusDisplay) intermediateMatchStatusDisplay.textContent = `リザルト: ${match.status || "未記録"}`; 
            
            if(intermediateMatchResultTableBody) intermediateMatchResultTableBody.innerHTML = ''; 

            let teamAScoreIntermediate, teamBScoreIntermediate;
            let teamAOrangeIntermediate = match.teamA_Orange !== undefined ? match.teamA_Orange : null;
            let teamAPurpleIntermediate = match.teamA_Purple !== undefined ? match.teamA_Purple : null;
            let teamBOrangeIntermediate = match.teamB_Orange !== undefined ? match.teamB_Orange : null;
            let teamBPurpleIntermediate = match.teamB_Purple !== undefined ? match.teamB_Purple : null;

            if (match.isColdGame) {
                if (match.penaltyLosingTeam === confirmedTeamA) { teamAScoreIntermediate = -4; teamBScoreIntermediate = 8; }
                else { teamAScoreIntermediate = 8; teamBScoreIntermediate = -4; }
            } else if (match.isPenaltyFixedScore) {
                if (match.penaltyLosingTeam === confirmedTeamA) { teamAScoreIntermediate = 8; teamBScoreIntermediate = -4; }
                else { teamAScoreIntermediate = -4; teamBScoreIntermediate = 8; }
            } else {
                if (teamAOrangeIntermediate !== null && teamAPurpleIntermediate !== null) teamAScoreIntermediate = teamAOrangeIntermediate - (teamAPurpleIntermediate * 2);
                if (teamBOrangeIntermediate !== null && teamBPurpleIntermediate !== null) teamBScoreIntermediate = teamBOrangeIntermediate - (teamBPurpleIntermediate * 2);
            }
            
            match.winner = null; 
            if (teamAScoreIntermediate !== null && teamBScoreIntermediate !== null) {
                if (teamAScoreIntermediate < teamBScoreIntermediate) match.winner = confirmedTeamA;
                else if (teamBScoreIntermediate < teamAScoreIntermediate) match.winner = confirmedTeamB;
                else match.winner = "draw";
            }

            const rowA = intermediateMatchResultTableBody.insertRow();
            const teamACellName = rowA.insertCell(); teamACellName.textContent = confirmedTeamADisplay;
            const teamACellOrange = rowA.insertCell(); teamACellOrange.textContent = teamAOrangeIntermediate !== null ? teamAOrangeIntermediate : "-";
            const teamACellPurple = rowA.insertCell(); teamACellPurple.textContent = teamAPurpleIntermediate !== null ? teamAPurpleIntermediate : "-"; 
            const teamACellScore = rowA.insertCell(); teamACellScore.textContent = teamAScoreIntermediate !== null ? teamAScoreIntermediate : "-";

            const rowB = intermediateMatchResultTableBody.insertRow();
            const teamBCellName = rowB.insertCell(); teamBCellName.textContent = confirmedTeamBDisplay;
            const teamBCellOrange = rowB.insertCell(); teamBCellOrange.textContent = teamBOrangeIntermediate !== null ? teamBOrangeIntermediate : "-";
            const teamBCellPurple = rowB.insertCell(); teamBCellPurple.textContent = teamBPurpleIntermediate !== null ? teamBPurpleIntermediate : "-"; 
            const teamBCellScore = rowB.insertCell(); teamBCellScore.textContent = teamBScoreIntermediate !== null ? teamBScoreIntermediate : "-";

            const cellsToHighlightAInter = [teamACellOrange, teamACellPurple, teamACellScore];
            const cellsToHighlightBInter = [teamBCellOrange, teamBCellPurple, teamBCellScore];

            cellsToHighlightAInter.forEach(cell => cell.classList.remove('highlight-winner-cell', 'highlight-draw-cell'));
            cellsToHighlightBInter.forEach(cell => cell.classList.remove('highlight-winner-cell', 'highlight-draw-cell'));

            if (match.winner === confirmedTeamA) {
                cellsToHighlightAInter.forEach(cell => cell.classList.add('highlight-winner-cell'));
                if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.textContent = `勝者: ${confirmedTeamADisplay}`;
                if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.style.color = 'green';
            } else if (match.winner === confirmedTeamB) {
                cellsToHighlightBInter.forEach(cell => cell.classList.add('highlight-winner-cell'));
                 if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.textContent = `勝者: ${confirmedTeamBDisplay}`;
                 if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.style.color = 'green';
            } else if (match.winner === "draw") {
                cellsToHighlightAInter.forEach(cell => cell.classList.add('highlight-draw-cell'));
                cellsToHighlightBInter.forEach(cell => cell.classList.add('highlight-draw-cell'));
                if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.textContent = "引き分け";
                if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.style.color = 'red';
            } else {
                 if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.textContent = "勝敗未定";
                 if(intermediateMatchWinnerDisplay) intermediateMatchWinnerDisplay.style.color = 'black';
            }


            if(goToNextStepButton) {
                goToNextStepButton.textContent = (currentMatchNumber < TOTAL_MATCHES) ? `第${currentMatchNumber + 1}マッチに進む` : "総合結果へ";
            }
            showPage(intermediateResultPage);
        }

        if(goToNextStepButton) goToNextStepButton.addEventListener('click', () => {
            if (currentMatchNumber < TOTAL_MATCHES) {
                setupNewMatch(currentMatchNumber + 1);
            } else {
                displayResults();
            }
        });


        // --- Results Page Logic ---
        function displayResults() {
            if(resultsTeamsDisplay) resultsTeamsDisplay.textContent = `${confirmedTeamADisplay} vs ${confirmedTeamBDisplay}`;
            if(resultsTableBody) resultsTableBody.innerHTML = ''; 
            
            let gameTotalWinsTeamA = 0;
            let gameTotalWinsTeamB = 0;
            let gameTotalFoulsTeamA = 0;
            let gameTotalFoulsTeamB = 0;
            let gameTotalOrangeBallsTeamA = 0;
            let gameTotalPurpleBallsTeamA = 0;
            let gameTotalOrangeBallsTeamB = 0;
            let gameTotalPurpleBallsTeamB = 0;


            for (let i = 0; i < TOTAL_MATCHES; i++) {
                const match = matchesData[i] || {}; 
                if(!resultsTableBody) continue;
                const row = resultsTableBody.insertRow();
                
                const cellMatchNum = row.insertCell();
                cellMatchNum.textContent = `第${i + 1}マッチ`;
                const cellStatus = row.insertCell();
                cellStatus.textContent = match.status || "未記録";

                // 違反回数の集計: match.isPenaltyFixedScore フラグと match.penaltyLosingTeam を使用
                if (match.isPenaltyFixedScore === true) { 
                    if (match.penaltyLosingTeam === confirmedTeamA) {
                        gameTotalFoulsTeamA++;
                    } else if (match.penaltyLosingTeam === confirmedTeamB) {
                        gameTotalFoulsTeamB++;
                    }
                }


                let teamAOrange = match.teamA_Orange !== undefined ? match.teamA_Orange : null;
                let teamAPurple = match.teamA_Purple !== undefined ? match.teamA_Purple : null;
                let teamAScore = null;

                let teamBOrange = match.teamB_Orange !== undefined ? match.teamB_Orange : null;
                let teamBPurple = match.teamB_Purple !== undefined ? match.teamB_Purple : null;
                let teamBScore = null;

                if (teamAOrange !== null) gameTotalOrangeBallsTeamA += teamAOrange;
                if (teamAPurple !== null) gameTotalPurpleBallsTeamA += teamAPurple;
                if (teamBOrange !== null) gameTotalOrangeBallsTeamB += teamBOrange;
                if (teamBPurple !== null) gameTotalPurpleBallsTeamB += teamBPurple;

                if (match.isColdGame) { 
                    if (match.penaltyLosingTeam === confirmedTeamA) { 
                        teamAScore = -4; teamBScore = 8;
                    } else if (match.penaltyLosingTeam === confirmedTeamB) { 
                        teamAScore = 8; teamBScore = -4;
                    }
                } else if (match.isPenaltyFixedScore) { 
                    if (match.penaltyLosingTeam === confirmedTeamA) { 
                        teamAScore = 8; 
                        teamBScore = -4;
                    } else if (match.penaltyLosingTeam === confirmedTeamB) { 
                        teamAScore = -4; 
                        teamBScore = 8; 
                    }
                } else { 
                    if (teamAOrange !== null && teamAPurple !== null) {
                        teamAScore = teamAOrange - (teamAPurple * 2);
                    }
                    if (teamBOrange !== null && teamBPurple !== null) {
                        teamBScore = teamBOrange - (teamBPurple * 2);
                    }
                }
                
                // match.winner should already be set by displayIntermediateResult
                if (match.winner === confirmedTeamA) { gameTotalWinsTeamA++; }
                else if (match.winner === confirmedTeamB) { gameTotalWinsTeamB++; }


                const cellTeamAOrange = row.insertCell(); cellTeamAOrange.textContent = teamAOrange !== null ? teamAOrange : "-";
                const cellTeamAPurple = row.insertCell(); cellTeamAPurple.textContent = teamAPurple !== null ? teamAPurple : "-";
                const cellTeamAScore = row.insertCell(); cellTeamAScore.textContent = teamAScore !== null ? teamAScore : "-";
                const cellTeamBOrange = row.insertCell(); cellTeamBOrange.textContent = teamBOrange !== null ? teamBOrange : "-";
                const cellTeamBPurple = row.insertCell(); cellTeamBPurple.textContent = teamBPurple !== null ? teamBPurple : "-";
                const cellTeamBScore = row.insertCell(); cellTeamBScore.textContent = teamBScore !== null ? teamBScore : "-";

                const cellsToHighlightA = [cellTeamAOrange, cellTeamAPurple, cellTeamAScore];
                const cellsToHighlightB = [cellTeamBOrange, cellTeamBPurple, cellTeamBScore];

                cellsToHighlightA.forEach(cell => cell.classList.remove('highlight-winner-cell', 'highlight-draw-cell'));
                cellsToHighlightB.forEach(cell => cell.classList.remove('highlight-winner-cell', 'highlight-draw-cell'));

                if (match.winner === confirmedTeamA) {
                    cellsToHighlightA.forEach(cell => cell.classList.add('highlight-winner-cell'));
                } else if (match.winner === confirmedTeamB) {
                    cellsToHighlightB.forEach(cell => cell.classList.add('highlight-winner-cell'));
                } else if (match.winner === "draw") {
                    cellsToHighlightA.forEach(cell => cell.classList.add('highlight-draw-cell'));
                    cellsToHighlightB.forEach(cell => cell.classList.add('highlight-draw-cell'));
                }
            }

            let overallWinner = null;
            let overallDraw = false;

            if (gameTotalWinsTeamA > gameTotalWinsTeamB) {
                overallWinner = confirmedTeamADisplay;
            } else if (gameTotalWinsTeamB > gameTotalWinsTeamA) {
                overallWinner = confirmedTeamBDisplay;
            } else { 
                if (gameTotalFoulsTeamA < gameTotalFoulsTeamB) {
                    overallWinner = confirmedTeamADisplay;
                } else if (gameTotalFoulsTeamB < gameTotalFoulsTeamA) {
                    overallWinner = confirmedTeamBDisplay;
                } else { 
                    const overallScoreTeamA = gameTotalOrangeBallsTeamA - (gameTotalPurpleBallsTeamA * 2);
                    const overallScoreTeamB = gameTotalOrangeBallsTeamB - (gameTotalPurpleBallsTeamB * 2);
                    if (overallScoreTeamA < overallScoreTeamB) { 
                        overallWinner = confirmedTeamADisplay;
                    } else if (overallScoreTeamB < overallScoreTeamA) {
                        overallWinner = confirmedTeamBDisplay;
                    } else { 
                        overallDraw = true;
                    }
                }
            }


            if (summaryStatsContainer) {
                summaryStatsContainer.innerHTML = `
                    <h3 class="font-bold mb-2 mt-4 text-xl">総計</h3>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>チーム</th>
                                <th>勝利マッチ数</th>
                                <th>総違反回数</th>
                                <th>総オレンジ</th>
                                <th>総紫</th>
                                <th>総ボールスコア</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="summaryRowTeamA">
                                <td id="summaryNameTeamA">${confirmedTeamADisplay}</td>
                                <td>${gameTotalWinsTeamA}</td>
                                <td>${gameTotalFoulsTeamA}</td>
                                <td>${gameTotalOrangeBallsTeamA}</td>
                                <td>${gameTotalPurpleBallsTeamA}</td>
                                <td>${gameTotalOrangeBallsTeamA - (gameTotalPurpleBallsTeamA * 2)}</td>
                            </tr>
                            <tr id="summaryRowTeamB">
                                <td id="summaryNameTeamB">${confirmedTeamBDisplay}</td>
                                <td>${gameTotalWinsTeamB}</td>
                                <td>${gameTotalFoulsTeamB}</td>
                                <td>${gameTotalOrangeBallsTeamB}</td>
                                <td>${gameTotalPurpleBallsTeamB}</td>
                                <td>${gameTotalOrangeBallsTeamB - (gameTotalPurpleBallsTeamB * 2)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;

                const summaryRowTeamA = document.getElementById('summaryRowTeamA');
                const summaryRowTeamB = document.getElementById('summaryRowTeamB');
                const summaryNameTeamA = document.getElementById('summaryNameTeamA');
                const summaryNameTeamB = document.getElementById('summaryNameTeamB');

                if (summaryRowTeamA) summaryRowTeamA.classList.remove('overall-winner-row');
                if (summaryRowTeamB) summaryRowTeamB.classList.remove('overall-winner-row');
                if (summaryNameTeamA) summaryNameTeamA.classList.remove('overall-draw-team-name');
                if (summaryNameTeamB) summaryNameTeamB.classList.remove('overall-draw-team-name');


                if (overallWinner === confirmedTeamADisplay && summaryRowTeamA) {
                    summaryRowTeamA.classList.add('overall-winner-row');
                } else if (overallWinner === confirmedTeamBDisplay && summaryRowTeamB) {
                    summaryRowTeamB.classList.add('overall-winner-row');
                } else if (overallDraw && summaryNameTeamA && summaryNameTeamB) {
                    summaryNameTeamA.classList.add('overall-draw-team-name');
                    summaryNameTeamB.classList.add('overall-draw-team-name');
                }
            }
            if(overallWinnerDisplay) {
                if (overallWinner) {
                    overallWinnerDisplay.textContent = `総合結果: ${overallWinner} の勝利！`;
                    overallWinnerDisplay.style.color = 'green';
                } else if (overallDraw) {
                    overallWinnerDisplay.textContent = "総合結果: 引き分け";
                    overallWinnerDisplay.style.color = 'red';
                } else {
                    overallWinnerDisplay.textContent = ""; 
                }
            }


            showPage(resultsPage);
        }
        
        if(startNewGameButton) startNewGameButton.addEventListener('click', () => {
            if (teamListFromCsv && teamListFromCsv.length > 0) {
                resetForNewGameWithSameCsv();
            } else {
                fullApplicationReset();
            }
        });
        if(fullResetButton) fullResetButton.addEventListener('click', fullApplicationReset);

        // --- Initial Setup ---
        function injectMissingHTML() {
            if (universalTeamSelectionPage && universalTeamSelectionPage.children.length === 0) {
                 const teamSelectionHTML = `
                    <div class="team-selection-container">
                        <h2 class="section-title">対戦チーム選択</h2>
                        <div class="csv-upload-container" id="csvUploadContainer">
                            <label for="csvFileInput" class="block mb-2 text-sm font-medium text-gray-900">チームリストCSVファイル (1列目: チーム番号, 2列目: チーム名):</label>
                            <input type="file" id="csvFileInput" accept=".csv" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                            <button id="loadCsvButton" class="btn btn-primary mt-2">CSV読み込み</button>
                        </div>
                        <div id="teamSelectDropdownsContainer" class="hidden">
                            <div class="team-select-group">
                                <label for="teamASelectInternal">審判左手:</label>
                                <select id="teamASelectInternal"><option value="">チームを選択</option></select>
                                <span class="mx-2 font-bold">vs</span>
                                <label for="teamBSelectInternal">審判右手:</label>
                                <select id="teamBSelectInternal"><option value="">チームを選択</option></select>
                            </div>
                            <div id="selectedTeamsDisplayInternal">チームを選択してください</div>
                            <button id="confirmTeamsButtonInternal" class="btn btn-primary mt-4" disabled>チーム決定して第1マッチへ</button>
                        </div>
                    </div>`;
                universalTeamSelectionPage.innerHTML = teamSelectionHTML;
                csvFileInput = document.getElementById('csvFileInput');
                loadCsvButton = document.getElementById('loadCsvButton');
                teamSelectDropdownsContainer = document.getElementById('teamSelectDropdownsContainer');
                if(loadCsvButton) loadCsvButton.addEventListener('click', () => { 
                    if (csvFileInput && csvFileInput.files && csvFileInput.files.length > 0) {
                        const file = csvFileInput.files[0];
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const csvData = event.target.result;
                            try {
                                const lines = csvData.split(/\r\n|\n/); 
                                teamListFromCsv = []; 
                                lines.forEach(line => {
                                    const columns = line.split(','); 
                                    if (columns[0] && columns[0].trim() !== "" && columns[1] && columns[1].trim() !== "") { 
                                        const teamNumber = columns[0].trim();
                                        const teamName = columns[1].trim();
                                        teamListFromCsv.push({ value: teamNumber, text: `${teamNumber} - ${teamName}` });
                                    }
                                });
                                if (teamListFromCsv.length > 0) {
                                    initializeTeamSelectionUI(); 
                                    const displayEl = document.getElementById('selectedTeamsDisplayInternal') || selectedTeamsDisplay;
                                    if(displayEl) displayEl.textContent = "CSVからチームを読み込みました。対戦チームを選択してください。";
                                    if(document.getElementById('csvUploadContainer')) document.getElementById('csvUploadContainer').classList.add('hidden');
                                } else {
                                     const displayEl = document.getElementById('selectedTeamsDisplayInternal') || selectedTeamsDisplay;
                                    if(displayEl) displayEl.textContent = "CSVファイルに有効なチーム情報（番号と名前）がありません。";
                                }
                            } catch (error) {
                                console.error("CSVパースエラー:", error);
                                const displayEl = document.getElementById('selectedTeamsDisplayInternal') || selectedTeamsDisplay;
                                if(displayEl) displayEl.textContent = "CSVファイルの読み込みに失敗しました。";
                            }
                        };
                        reader.onerror = function() {
                            console.error("ファイル読み込みエラー");
                             const displayEl = document.getElementById('selectedTeamsDisplayInternal') || selectedTeamsDisplay;
                            if(displayEl) displayEl.textContent = "ファイル読み込み中にエラーが発生しました。";
                        };
                        reader.readAsText(file, 'UTF-8'); 
                    } else {
                         const displayEl = document.getElementById('selectedTeamsDisplayInternal') || selectedTeamsDisplay;
                        if(displayEl) displayEl.textContent = "CSVファイルを選択してください。";
                    }
                });
            }
            if (scoreInputPage && scoreInputPage.children.length === 0) {
                const scoreInputHTML = `
                    <div class="score-input-page-container">
                        <div id="currentMatchScoreTitleInternal" class="match-title-display">第Xマッチ ボール数入力</div>
                        <div id="selectedStatusOnScorePageInternal" class="record-display">状態記録がここに表示されます</div>
                        <div class="score-input-area">
                            <div class="score-team-section">
                                <h3 id="scoreTeamANameInternal">チームA</h3>
                                <div class="score-input-group">
                                    <label for="teamAOrangeBallsSelectInternal">オレンジボール (0-8):</label>
                                    <select id="teamAOrangeBallsSelectInternal" disabled></select>
                                </div>
                                <div class="score-input-group">
                                    <label for="teamAPurpleBallsSelectInternal">紫ボール (0-2):</label>
                                    <select id="teamAPurpleBallsSelectInternal" disabled></select>
                                </div>
                            </div>
                            <div class="score-team-section">
                                <h3 id="scoreTeamBNameInternal">チームB</h3>
                                <div class="score-input-group">
                                    <label for="teamBOrangeBallsSelectInternal">オレンジボール (0-8):</label>
                                    <select id="teamBOrangeBallsSelectInternal" disabled></select>
                                </div>
                                <div class="score-input-group">
                                    <label for="teamBPurpleBallsSelectInternal">紫ボール (0-2):</label>
                                    <select id="teamBPurpleBallsSelectInternal" disabled></select>
                                </div>
                            </div>
                        </div>
                        <div class="next-match-btn-container">
                            <button id="proceedToNextPhaseButtonInternal" class="btn btn-primary" disabled>確定</button>
                        </div>
                        <button id="backToMatchTimerButtonInternal" class="btn btn-secondary mt-3">リザルト変更</button>
                    </div>`;
                scoreInputPage.innerHTML = scoreInputHTML;
            }
             if (intermediateResultPage && intermediateResultPage.children.length === 0) { 
                const intermediateResultHTML = `
                    <div class="intermediate-result-page-container">
                        <h2 id="intermediateResultTitleInternal" class="section-title match-title-display">第Xマッチ 結果</h2>
                        <div id="intermediateMatchTeamsInternal" class="results-teams-display">チームA vs チームB</div>
                        <div id="intermediateMatchStatusDisplayInternal" class="record-display my-3">リザルト: 未記録</div>
                        <table id="intermediateMatchResultTableInternal" class="results-table">
                            <thead>
                                <tr>
                                    <th>チーム</th>
                                    <th>オレンジ</th>
                                    <th>紫</th>
                                    <th>得点</th>
                                </tr>
                            </thead>
                            <tbody id="intermediateMatchResultTableBodyInternal">
                            </tbody>
                        </table>
                        <div id="intermediateMatchWinnerDisplayInternal" class="font-bold text-xl my-4">勝者: チームX</div>
                        <button id="goToNextStepButtonInternal" class="btn btn-primary">次へ進む</button>
                    </div>`;
                intermediateResultPage.innerHTML = intermediateResultHTML;
            }
             if (resultsPage && resultsPage.children.length === 0) {
                const resultsHTML = `
                    <div class="results-page-container">
                        <h2 class="section-title match-title-display">試合結果</h2>
                        <div id="resultsTeamsDisplayInternal" class="results-teams-display">チームA vs チームB</div>
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">マッチ</th> <th rowspan="2">リザルト</th>
                                    <th colspan="3" id="resultsHeaderTeamAInternal">チームA</th>
                                    <th colspan="3" id="resultsHeaderTeamBInternal">チームB</th>
                                </tr>
                                <tr>
                                    <th>オレンジ</th><th>紫</th><th>得点</th>
                                    <th>オレンジ</th><th>紫</th><th>得点</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBodyInternal"></tbody>
                        </table>
                        <div id="summaryStatsContainerInternal"></div>
                        <div id="overallWinnerDisplayInternal" class="mt-4 font-bold text-2xl"></div>
                        <button id="startNewGameButtonInternal" class="btn btn-success mt-4">新しい試合を開始</button>
                    </div>`;
                resultsPage.innerHTML = resultsHTML;
            }
        }

        function reassignDynamicPageElements() {
            currentMatchScoreTitle = document.getElementById('currentMatchScoreTitleInternal') || document.getElementById('currentMatchScoreTitle');
            selectedStatusOnScorePage = document.getElementById('selectedStatusOnScorePageInternal') || document.getElementById('selectedStatusOnScorePage');
            scoreTeamAName = document.getElementById('scoreTeamANameInternal') || document.getElementById('scoreTeamAName');
            teamAOrangeBallsSelect = document.getElementById('teamAOrangeBallsSelectInternal') || document.getElementById('teamAOrangeBallsSelect');
            teamAPurpleBallsSelect = document.getElementById('teamAPurpleBallsSelectInternal') || document.getElementById('teamAPurpleBallsSelect');
            scoreTeamBName = document.getElementById('scoreTeamBNameInternal') || document.getElementById('scoreTeamBName');
            teamBOrangeBallsSelect = document.getElementById('teamBOrangeBallsSelectInternal') || document.getElementById('teamBOrangeBallsSelect');
            teamBPurpleBallsSelect = document.getElementById('teamBPurpleBallsSelectInternal') || document.getElementById('teamBPurpleBallsSelect');
            proceedToNextPhaseButton = document.getElementById('proceedToNextPhaseButtonInternal') || document.getElementById('proceedToNextPhaseButton');
            backToMatchTimerButton = document.getElementById('backToMatchTimerButtonInternal') || document.getElementById('backToMatchTimerButton');
            
            intermediateResultTitle = document.getElementById('intermediateResultTitleInternal') || document.getElementById('intermediateResultTitle');
            intermediateMatchTeams = document.getElementById('intermediateMatchTeamsInternal') || document.getElementById('intermediateMatchTeams');
            intermediateMatchStatusDisplay = document.getElementById('intermediateMatchStatusDisplayInternal') || document.getElementById('intermediateMatchStatusDisplay');
            intermediateMatchResultTableBody = document.getElementById('intermediateMatchResultTableBodyInternal') || document.getElementById('intermediateMatchResultTableBody');
            intermediateMatchWinnerDisplay = document.getElementById('intermediateMatchWinnerDisplayInternal') || document.getElementById('intermediateMatchWinnerDisplay');
            goToNextStepButton = document.getElementById('goToNextStepButtonInternal') || document.getElementById('goToNextStepButton');


             if(backToMatchTimerButton) backToMatchTimerButton.addEventListener('click', () => { 
                showPage(matchPlayPage);
                 if (manualEndReasonContainer && timerControlsActive && !timerRunning && !manualEndReasonContainer.classList.contains('hidden')) {
                    timerControlsActive.classList.remove('hidden');
                    if(startButtonActive) startButtonActive.disabled = true;
                    if(pauseButton) pauseButton.disabled = true;
                    if(endMatchButton) endMatchButton.disabled = false; 
                    if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
                } else if (timeoutInfoContainer && timerControlsActive && !timerRunning && !timeoutInfoContainer.classList.contains('hidden')) {
                    timerControlsActive.classList.remove('hidden');
                    if(startButtonActive) startButtonActive.disabled = true;
                    if(pauseButton) pauseButton.disabled = true;
                    if(endMatchButton) endMatchButton.disabled = true;
                    if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
                }
            });
            if(teamAOrangeBallsSelect) teamAOrangeBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamAOrangeBallsSelect, teamBOrangeBallsSelect, MAX_ORANGE_BALLS));
            if(teamBOrangeBallsSelect) teamBOrangeBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamBOrangeBallsSelect, teamAOrangeBallsSelect, MAX_ORANGE_BALLS));
            if(teamAPurpleBallsSelect) teamAPurpleBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamAPurpleBallsSelect, teamBPurpleBallsSelect, MAX_PURPLE_BALLS));
            if(teamBPurpleBallsSelect) teamBPurpleBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamBPurpleBallsSelect, teamAPurpleBallsSelect, MAX_PURPLE_BALLS));
            
            if(proceedToNextPhaseButton) proceedToNextPhaseButton.addEventListener('click', () => {
                displayIntermediateResult(currentMatchNumber - 1);
            });
            if(goToNextStepButton) goToNextStepButton.addEventListener('click', () => {
                if (currentMatchNumber < TOTAL_MATCHES) {
                    setupNewMatch(currentMatchNumber + 1);
                } else {
                    displayResults();
                }
            });


            resultsTeamsDisplay = document.getElementById('resultsTeamsDisplayInternal') || document.getElementById('resultsTeamsDisplay');
            resultsHeaderTeamA = document.getElementById('resultsHeaderTeamAInternal') || document.getElementById('resultsHeaderTeamA');
            resultsHeaderTeamB = document.getElementById('resultsHeaderTeamBInternal') || document.getElementById('resultsHeaderTeamB');
            resultsTableBody = document.getElementById('resultsTableBodyInternal') || document.getElementById('resultsTableBody');
            startNewGameButton = document.getElementById('startNewGameButtonInternal') || document.getElementById('startNewGameButton');
            summaryStatsContainer = document.getElementById('summaryStatsContainerInternal') || document.getElementById('summaryStatsContainer'); 
            overallWinnerDisplay = document.getElementById('overallWinnerDisplayInternal') || document.getElementById('overallWinnerDisplay');
            if(startNewGameButton) startNewGameButton.addEventListener('click', () => {
                if (teamListFromCsv && teamListFromCsv.length > 0) {
                    resetForNewGameWithSameCsv();
                } else {
                    fullApplicationReset();
                }
            });
        }


        window.onload = () => {
            injectMissingHTML(); 
            reassignDynamicPageElements(); 

            if(startButton) startButton.addEventListener('click', startTimer);
            if(startButtonActive) startButtonActive.addEventListener('click', startTimer); 
            if(pauseButton) pauseButton.addEventListener('click', pauseTimer);
            if(fullResetButton) fullResetButton.addEventListener('click', fullApplicationReset);
            
            fullApplicationReset(); 
        };
    </script>
</body>
</html>
