<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboSports審判支援ツール</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS: ユーティリティクラスベースのCSSフレームワークをCDN経由で読み込み、迅速なUI開発を可能にする -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js: Web Audio APIを簡単に扱うためのライブラリ。タイマーの開始・終了時に音を鳴らすために使用 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* --- 全体スタイル --- */
        body {
            font-family: 'Inter', sans-serif; /* フォント指定 */
            display: flex; /* Flexboxレイアウトを有効化 */
            flex-direction: column; /* 要素を縦方向に並べる */
            align-items: center; /* 水平方向中央揃え */
            justify-content: flex-start; /* 垂直方向上揃え */
            min-height: 100vh; /* 画面全体の高さを確保 */
            background-color: #f0f4f8; /* 背景色を薄いグレーに設定 */
            color: #333; /* 基本の文字色 */
            margin: 0; /* body要素のデフォルトマージンを削除 */
            padding: 20px; /* body要素の内側に余白を設定 */
            box-sizing: border-box; /* paddingとborderをwidth/heightの計算に含める */
        }
        .container {
            background-color: #ffffff; /* コンテンツ全体の背景色を白に設定 */
            padding: 20px; /* 内側の余白 */
            border-radius: 12px; /* 角を丸くする */
            box-shadow: 0 8px 16px rgba(0,0,0,0.1); /* 影をつけて立体感を出す */
            width: 100%; /* 親要素いっぱいに幅を広げる */
            max-width: 700px; /* 最大幅を指定し、大きな画面でも見やすくする */
            text-align: center; /* テキストを中央揃えにする */
        }
        .page { width: 100%; } /* 各ページの共通スタイル */

        /* --- マッチタイトル表示 --- */
        .match-title-display {
            font-size: 2.25rem; /* 文字サイズ (36px) */
            font-weight: bold; /* 太字 */
            color: #111827; /* 文字色 (濃いグレー) */
            margin-bottom: 5px; /* 下の余白を少し調整 */
        }
        #currentMatchTeamsDisplay { /* タイマー画面の対戦チーム表示用のスタイル */
            font-size: 1.5rem; /* 文字サイズ */
            font-weight: 600; /* 少し太く */
            color: #374151; /* 文字色 (グレー) */
            margin-bottom: 15px; /* 下の余白 */
        }

        /* --- チーム選択エリア --- */
        .team-selection-container {
            margin-bottom: 20px; /* 下の余白 */
            padding-bottom: 20px; /* 下の内側余白 */
            border-bottom: 1px solid #e5e7eb; /* 下に境界線 */
        }
        
        .team-selection-container h2, .section-title { /* セクションタイトルの共通スタイル */
            font-size: 1.25rem; /* 文字サイズ (20px) */
            font-weight: 600; /* 文字の太さ */
            margin-bottom: 10px; /* 下の余白 */
            color: #374151; /* 文字色 (グレー) */
        }
        .csv-upload-container { /* CSVアップロードエリアのスタイル */
            margin-bottom: 20px;
        }
        .csv-upload-container input[type="file"] { /* ファイル選択ボタンのスタイル */
            margin-bottom: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .team-select-group {
            display: flex; /* Flexboxレイアウト */
            justify-content: space-around; /* 要素間のスペースを均等に配置 */
            align-items: center; /* 垂直方向中央揃え */
            gap: 10px; /* 要素間の隙間 */
            margin-bottom: 10px; /* 下の余白 */
        }
        .team-select-group label { font-size: 0.9rem; color: #4b5563; } /* ラベルのスタイル */
        .team-select-group select { /* プルダウンメニューのスタイル */
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background-color: #fff;
            flex-grow: 1; /* 親要素の幅に合わせて伸びる */
        }
        #selectedTeamsDisplay { /* 選択されたチーム表示エリアのスタイル */
            font-size: 1.1rem; font-weight: bold; color: #1e40af;
            margin-top: 10px; min-height: 25px;
        }

        /* --- タイマー表示 --- */
        .timer-display {
            font-size: 7rem; /* 文字サイズを非常に大きく */
            font-weight: bold; /* 太字 */
            margin-bottom: 20px; /* 下の余白 */
            padding: 10px; /* 内側の余白 */
            background-color: #eff6ff; /* 背景色 (薄い青) */
            border-radius: 8px; /* 角を丸くする */
        }
        /* タイマーの状態によって色を変えるクラス */
        .timer-paused { color: #f59e0b; } /* 黄色 - 一時停止時 */
        .timer-ended { color: #dc2626; } /* 赤色 - 終了時 */
        .timer-running { color: #1d4ed8; } /* 青色 - 実行中/リセット時 */

        /* --- ボール配置表示 --- */
        .arrangement-container {
            display: flex;
            justify-content: space-around; /* 左右に均等配置 */
            margin-top: 20px;
        }
        .side-container {
            display: flex;
            flex-direction: column; /* 縦に並べる */
            gap: 10px;
        }
        .side-container h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .circle-pair {
            display: flex;
            gap: 10px;
        }
        .outer-circle { /* ボールを配置する外側の円 */
            width: 60px;
            height: 60px;
            border: 3px solid orange;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .inner-circle { /* ボール本体を表す内側の円 */
            width: 45px;
            height: 45px;
            border-radius: 50%;
        }
        .inner-circle.orange { background-color: orange; }
        .inner-circle.purple { background-color: purple; }

        /* --- ボタン共通スタイル --- */
        .button-group {
            display: flex; flex-wrap: wrap; justify-content: center;
            gap: 10px; margin-bottom: 20px;
        }
        .btn {
            padding: 10px 15px; font-size: 1rem; border-radius: 8px;
            border: none; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease; /* ホバーやクリック時のアニメーション効果 */
            min-width: 100px; /* 最小幅 */
        }
        .btn:active { transform: scale(0.98); } /* クリック時に少し縮む効果 */
        /* ボタンの種類ごとの色設定 */
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn:disabled { /* 無効状態のボタンスタイル */
            background-color: #9ca3af; color: #e5e7eb; cursor: not-allowed;
        }

        /* --- 各セクションコンテナ --- */
        .status-handling-container {
            border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 20px;
        }
        .score-input-page-container, 
        .intermediate-result-page-container,
        .results-page-container {
             padding-top: 20px; margin-top: 20px;
        }
        .record-display { /* 記録表示エリア（タイマーページ）のスタイル */
            margin-top: 10px; padding: 10px 15px; background-color: #f3f4f6;
            border-radius: 8px; font-size: 1rem; color: #1f2937;
            min-height: 40px; display: flex; align-items: center; justify-content: center;
        }
        .record-display.recorded { /* 記録が選択された時のスタイル */
            background-color: #d1fae5; color: #065f46; font-weight: bold;
        }
        
        /* --- タイムアウト時・手動終了時の情報エリア --- */
        #timeoutInfoContainer { margin-top: 15px; }
        #manualEndReasonContainer .team-select-group { 
            margin-bottom: 15px; 
        }

        /* --- ボール数入力ページ --- */
        #selectedStatusOnScorePage { 
            font-size: 1.1rem; 
            font-weight: 500; 
            color: #1f2937; 
            background-color: #f3f4f6; 
            padding: 10px 15px;
            border-radius: 8px; margin-bottom: 20px;
        }
        .score-input-area { 
            display: flex; justify-content: space-around; gap: 20px; margin-top: 10px;
        }
        .score-team-section { 
            flex: 1; padding: 15px; border: 1px solid #d1d5db;
            border-radius: 8px; background-color: #f9fafb;
        }
        .score-team-section h3 { 
            font-size: 1.1rem; font-weight: 600; color: #374151; margin-bottom: 10px;
        }
        .score-input-group { margin-bottom: 10px; } 
        .score-input-group label { 
            display: block; font-size: 0.9rem; color: #4b5563; margin-bottom: 5px;
        }
        .score-input-group select { 
            width: 100%; padding: 8px; border-radius: 6px;
            border: 1px solid #d1d5db; box-sizing: border-box;
        }
        .score-input-group select:disabled { 
            background-color: #e5e7eb; 
        }
        .next-match-btn-container button { margin-top: 20px; } 

        /* --- 中間結果表示ページ --- */
        #intermediateMatchResultTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #intermediateMatchResultTable th, #intermediateMatchResultTable td {
            border: 2px solid #000000; 
            padding: 8px 12px; text-align: left;
            font-size: 1.25rem; 
        }
        #intermediateMatchResultTable th { background-color: #f3f4f6; font-weight: 600; }
        #intermediateMatchStatusDisplay { 
             font-size: 1.1rem; font-weight: 500; margin-bottom: 10px;
             padding: 8px; background-color: #eef2ff; border-radius: 6px;
        }
        #intermediateMatchWinnerDisplay { font-size: 1.5rem; font-weight: bold; margin-top: 15px; margin-bottom: 15px; }

        /* --- 最終結果表示ページ --- */
        .results-table { width: 100%; border-collapse: collapse; margin-top: 15px; } 
        .results-table th, .results-table td { 
            border: 2px solid #000000; 
            padding: 8px 12px; text-align: left;
            font-size: 1.25rem; 
        }
        .results-table th { background-color: #f3f4f6; font-weight: 600; } 
        .results-teams-display { font-size: 1.2rem; font-weight: bold; margin-bottom:15px; } 
        
        /* 勝者や引き分けのセルをハイライト表示するためのスタイル */
        .highlight-winner-cell { 
            background-color: #dcfce7; /* 勝者: 薄い緑 */
        }
        .highlight-draw-cell { 
            background-color: #fee2e2; /* 引き分け: 薄い赤 */
        }

        /* --- 総合成績サマリー --- */
        #summaryStatsContainer { 
            margin-top: 30px;
            text-align: left;
        }
        .summary-table { 
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .summary-table th, .summary-table td { 
            border: 2px solid #000000; 
            padding: 8px;
            text-align: center;
            font-size: 1.1rem;
        }
        .summary-table th { 
            background-color: #e9ecef;
        }
        .overall-winner-row td { 
            background-color: #a7f3d0; /* 総合勝者の行のハイライト */
            font-weight: bold;
        }
        .overall-draw-team-name { 
             background-color: #fecaca; /* 総合引き分けのチーム名のハイライト */
             font-weight: bold;
        }
        /* --- 確認モーダル (確認ダイアログ) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; /* 画面全体を覆う */
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* 半透明の黒い背景 */
            display: flex; justify-content: center; align-items: center; /* 中央に配置 */
            z-index: 1000; /* 他の要素より手前に表示 */
        }
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around; 
            margin-top: 20px;
        }

        /* --- 要素を非表示にするためのユーティリティクラス --- */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- 全体のコンテナ -->
    <div class="container">
        <!-- メインタイトルと全体リセットボタン -->
        <h1 id="mainTitle" class="text-3xl font-bold mb-2 text-gray-800">RoboSports審判支援ツール</h1>
        <button id="fullResetButton" class="btn btn-danger mb-4">全体リセット</button>

        <!-- ページ1: チーム選択ページ (中身はJSで動的生成) -->
        <div id="universalTeamSelectionPage" class="page"></div>

        <!-- ページ2: ボール配置表示ページ -->
        <div id="ballArrangementPage" class="page hidden">
            <h2 class="match-title-display">ボール配置</h2>
            <div class="arrangement-container">
                <!-- 左側と右側の配置エリア (中身はJSで動的生成) -->
                <div id="leftArrangement" class="side-container">
                    <h3>左側</h3>
                </div>
                <div id="rightArrangement" class="side-container">
                    <h3>右側</h3>
                </div>
            </div>
            <button id="proceedToMatch1Button" class="btn btn-primary mt-6">第1マッチに進む</button>
        </div>

        <!-- ページ3: マッチ進行ページ (タイマー) -->
        <div id="matchPlayPage" class="page hidden">
            <div id="currentMatchDisplay" class="match-title-display">第Xマッチ</div>
            <div id="currentMatchTeamsDisplay" class="text-lg font-medium text-gray-700 mb-4">審判左手 vs 審判右手</div>
            <div id="timerDisplay" class="timer-display timer-running">02:00</div>

            <!-- 試合開始前のタイマー操作ボタン -->
            <div id="timerControlsPreStart" class="button-group">
                <button id="startButton" class="btn btn-primary">開始</button>
            </div>
            <!-- 試合中のタイマー操作ボタン -->
            <div id="timerControlsActive" class="button-group hidden">
                <button id="startButtonActive" class="btn btn-primary" disabled>開始</button>
                <button id="pauseButton" class="btn btn-secondary">一時停止</button>
                <button id="endMatchButton" class="btn btn-danger">試合手動終了</button>
                <button id="resetMatchTimerButton" class="btn btn-warning" disabled>このマッチのタイマーをリセット</button>
            </div>
            
            <!-- 試合終了後の操作エリア -->
            <div class="status-handling-container">
                <div id="proceedToResultContainer" class="hidden mt-4">
                    <button id="proceedToResultButton" class="btn btn-primary">リザルト入力へ進む</button>
                </div>
            </div>
            <!-- 現在の状態表示エリア -->
            <div id="recordDisplayOnTimerPage" class="record-display">記録待機中...</div>
        </div>

        <!-- ページ4: スコア入力ページ (中身はJSで動的生成) -->
        <div id="scoreInputPage" class="page hidden"></div>

        <!-- ページ5: 中間結果表示ページ -->
        <div id="intermediateResultPage" class="page hidden">
            <div class="intermediate-result-page-container">
                <h2 id="intermediateResultTitle" class="match-title-display">第Xマッチ 結果</h2>
                <div id="intermediateMatchTeams" class="results-teams-display">チームA vs チームB</div>
                <div id="intermediateMatchStatusDisplay" class="record-display my-3 hidden">リザルト: 未記録</div> 
                <table id="intermediateMatchResultTable" class="results-table">
                    <thead>
                        <tr>
                            <th>チーム</th> 
                            <th>オレンジ</th>
                            <th>紫</th>
                            <th>得点</th>
                        </tr>
                    </thead>
                    <tbody id="intermediateMatchResultTableBody">
                        <!-- 結果はJSで動的に生成 -->
                    </tbody>
                </table>
                <div id="intermediateMatchWinnerDisplay" class="font-bold text-xl my-4">勝者: チームX</div>
                <div class="button-group" style="flex-direction: column; align-items: center;"> 
                    <button id="goToNextStepButton" class="btn btn-primary">次へ進む</button>
                    <button id="editMatchResultButton" class="btn btn-secondary">リザルトを変更</button>
                </div>
            </div>
        </div>

        <!-- ページ6: 最終結果表示ページ -->
        <div id="resultsPage" class="page hidden">
            <div class="results-page-container">
                <h2 class="match-title-display">試合結果</h2>
                <div id="resultsTeamsDisplay" class="results-teams-display">チームA vs チームB</div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th rowspan="2">マッチ</th>
                            <th rowspan="2">リザルト</th> 
                            <th colspan="3" id="resultsHeaderTeamA">チームA</th> 
                            <th colspan="3" id="resultsHeaderTeamB">チームB</th> 
                        </tr>
                        <tr>
                            <th>オレンジ</th>
                            <th>紫</th>
                            <th>得点</th>
                            <th>オレンジ</th>
                            <th>紫</th>
                            <th>得点</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- 結果はJSで動的に生成 -->
                    </tbody>
                </table>
                <!-- 総合成績サマリーエリア (中身はJSで動的生成) -->
                <div id="summaryStatsContainer"></div>
                <div id="overallWinnerDisplay" class="mt-4 font-bold text-2xl"></div>
                <button id="startNewGameButton" class="btn btn-success mt-4">新しい試合を開始</button>
            </div>
        </div>

        <!-- 確認モーダル (ダイアログ) -->
        <div id="confirmationModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 id="confirmationModalMessage">試合を終了しますか？</h3>
                <div class="modal-buttons">
                    <button id="confirmEndMatchButton" class="btn btn-danger">終了する</button>
                    <button id="cancelEndMatchButton" class="btn btn-secondary">継続する</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 全画面表示切り替えボタン -->
    <button id="fullscreenButton" class="btn btn-secondary mt-4">全画面表示</button>

    <script>
        // ===================================================================================
        // --- DOM Elements (HTML要素の取得) ---
        // ===================================================================================
        // JavaScriptから操作するために、HTML内の各要素をIDで取得し、変数に格納する。
        // nullで初期化されている変数は、JavaScriptによって後から動的に生成される要素。

        // 各ページのコンテナ要素
        const universalTeamSelectionPage = document.getElementById('universalTeamSelectionPage');
        const ballArrangementPage = document.getElementById('ballArrangementPage'); 
        const matchPlayPage = document.getElementById('matchPlayPage');
        const scoreInputPage = document.getElementById('scoreInputPage');
        const intermediateResultPage = document.getElementById('intermediateResultPage'); 
        const resultsPage = document.getElementById('resultsPage');
        
        // 確認モーダル関連の要素
        const confirmationModal = document.getElementById('confirmationModal'); 
        const confirmEndMatchButton = document.getElementById('confirmEndMatchButton');
        const cancelEndMatchButton = document.getElementById('cancelEndMatchButton');
        
        // チーム選択ページ内の要素 (動的に生成されるため初期値はnull)
        let csvFileInput = null; 
        let loadCsvButton = null; 
        let teamSelectDropdownsContainer = null; 
        let teamASelect = null; 
        let teamBSelect = null; 
        let selectedTeamsDisplay = null; 
        let confirmTeamsButton = null; 
        
        // その他の共通要素
        const mainTitle = document.getElementById('mainTitle');
        const fullResetButton = document.getElementById('fullResetButton');
        const currentMatchDisplay = document.getElementById('currentMatchDisplay');
        const currentMatchTeamsDisplay = document.getElementById('currentMatchTeamsDisplay'); 
        const timerDisplay = document.getElementById('timerDisplay');
        
        // タイマー操作ボタン
        const timerControlsPreStart = document.getElementById('timerControlsPreStart');
        const timerControlsActive = document.getElementById('timerControlsActive');
        const startButton = document.getElementById('startButton'); 
        const startButtonActive = document.getElementById('startButtonActive'); 
        const pauseButton = document.getElementById('pauseButton');
        const resetMatchTimerButton = document.getElementById('resetMatchTimerButton');
        const endMatchButton = document.getElementById('endMatchButton'); 
        
        // スコア入力ページ内の手動終了・記録関連要素 (動的生成)
        let manualEndReasonContainer = null;
        let endedByTeamSelect = null;
        let endReasonSelect = null;
        
        // 試合終了時に表示されるコンテナとボタン
        const proceedToResultContainer = document.getElementById('proceedToResultContainer');
        const proceedToResultButton = document.getElementById('proceedToResultButton');
        const recordDisplayOnTimerPage = document.getElementById('recordDisplayOnTimerPage');

        // スコア入力ページ内の要素 (動的に生成されるため初期値はnull)
        let scoreTeamAName = null; 
        let teamAOrangeBallsSelect = null; 
        let teamAPurpleBallsSelect = null; 
        let scoreTeamBName = null; 
        let teamBOrangeBallsSelect = null; 
        let teamBPurpleBallsSelect = null; 
        let proceedToNextPhaseButton = null;
        let currentMatchScoreTitle = null;
        
        // ボール配置ページ要素
        const leftArrangementDiv = document.getElementById('leftArrangement');
        const rightArrangementDiv = document.getElementById('rightArrangement');
        const proceedToMatch1Button = document.getElementById('proceedToMatch1Button');

        // 中間結果ページ要素
        let intermediateResultTitle = document.getElementById('intermediateResultTitle');
        let intermediateMatchTeams = document.getElementById('intermediateMatchTeams');
        let intermediateMatchStatusDisplay = document.getElementById('intermediateMatchStatusDisplay'); 
        let intermediateMatchResultTableBody = document.getElementById('intermediateMatchResultTableBody');
        let intermediateMatchWinnerDisplay = document.getElementById('intermediateMatchWinnerDisplay');
        let goToNextStepButton = document.getElementById('goToNextStepButton');
        let editMatchResultButton = document.getElementById('editMatchResultButton'); 

        // 最終結果ページ要素
        let resultsTeamsDisplay = document.getElementById('resultsTeamsDisplay');
        let resultsHeaderTeamA = document.getElementById('resultsHeaderTeamA'); 
        let resultsHeaderTeamB = document.getElementById('resultsHeaderTeamB'); 
        let resultsTableBody = document.getElementById('resultsTableBody');
        let startNewGameButton = document.getElementById('startNewGameButton');
        let summaryStatsContainer = document.getElementById('summaryStatsContainer'); 
        let overallWinnerDisplay = document.getElementById('overallWinnerDisplay');
        
        const fullscreenButton = document.getElementById('fullscreenButton');


        // ===================================================================================
        // --- Game State (アプリケーションの状態管理) ---
        // ===================================================================================
        // アプリケーション全体で共有される設定値や状態を保持する変数。

        const TOTAL_MATCHES = 3; // 試合は3マッチ制
        const INITIAL_TIME_SECONDS = 2 * 60; // 試合時間: 2分 (120秒)
        const MAX_ORANGE_BALLS = 8; // オレンジボールの最大数
        const MAX_PURPLE_BALLS = 2; // 紫ボールの最大数

        let currentMatchNumber = 1; // 現在のマッチ番号 (1, 2, 3)
        let timeLeft = INITIAL_TIME_SECONDS; // 残り時間（秒）
        let timerInterval = null; // setIntervalのID。タイマーを停止するために使用
        let timerRunning = false; // タイマーが作動中かどうかのフラグ
        let matchEndType = 'timeout'; // 試合の終了方法 ('timeout' or 'manual')
        
        let confirmedTeamA = ""; // 確定したチームAの内部ID (CSVの番号など)
        let confirmedTeamB = ""; // 確定したチームBの内部ID
        let confirmedTeamADisplay = ""; // 確定したチームAの表示名
        let confirmedTeamBDisplay = ""; // 確定したチームBの表示名
        
        // ★変更点: CSVから読み込む代わりに、チームリストを直接コードに記述する
        const teamListFromCsv = [
            { value: '1', text: '1 - 夙川第三世代' },
            { value: '2', text: '2 - うなぎRO' },
            { value: '3', text: '3 - SPEED' },
            { value: '4', text: '4 - Tezukayamaの森' },
            { value: '5', text: '5 - Ousho' },
            { value: '6', text: '6 - SS' },
            { value: '7', text: '7 - なんでもいい' },
            { value: '8', text: '8 - 月島ダイナソー' },
            { value: '9', text: '9 - Assassin' },
            { value: '10', text: '10 - フローライト' },
            { value: '11', text: '11 - PK4' },
            { value: '12', text: '12 - 土曜出勤@spike信者' },
            { value: '13', text: '13 - むしくん' },
            { value: '14', text: '14 - いわし　にんじん　マヨネーズ' },
            { value: '15', text: '15 - すっしーず' },
            { value: '16', text: '16 - ロマン砲・Ω' },
            { value: '17', text: '17 - SKY1' },
            { value: '18', text: '18 - BLUE1' }
        ];
        let matchesData = []; // 各マッチの結果を格納する配列。インデックスが (マッチ番号 - 1) に対応。

        // 反則（自動で相手の得点になり、違反回数にカウントされる）と見なされる理由のリスト
        const PENALTY_FIXED_SCORE_REASONS = [ 
            "レッドゾーン接触(6.27)",
            "故意のロボット接触(6.28)",
            "相手フィールド接触(6.29)",
            "分離パーツ接触(6.23)",
            "試合開始後10秒ロボット不動(6.20)",
            "両ロボット除去(6.21)", 
            "両ロボット脱走(6.32.6)", 
            "ロボットのサイズ超過(6.32.3)",
            "フィールド・ボール破壊(6.32.7・6.32.8)",
            "選手のロボット接触(6.33)",
            "選手のフィールド接触(6.32.5)"
        ];
        // 総違反回数としてカウントされる理由のリスト（今回は上記PENALTY_FIXED_SCORE_REASONSと同じ）
        const FOUL_COUNTING_REASONS = [...PENALTY_FIXED_SCORE_REASONS];

        // ===================================================================================
        // --- Audio Setup (Tone.jsによる音声設定) ---
        // ===================================================================================
        let synth = null; // 音を出すためのシンセサイザーオブジェクト
        const BEEP_VOLUME = 0; // ビープ音の音量 (0はデフォルト音量)

        /**
         * 音声再生の初期化。ユーザーが最初に画面を操作したときに実行される。
         * ブラウザの自動再生ポリシーを回避するため、ユーザーのアクションをトリガーにする必要がある。
         */
        function initializeAudio() {
            if (!synth && typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    console.log("AudioContext started by Tone.js");
                    synth = new Tone.Synth({ volume: BEEP_VOLUME }).toDestination();
                }).catch(e => {
                    console.error("Error starting Tone.js AudioContext:", e);
                });
            } else if (!synth && typeof Tone !== 'undefined') {
                 synth = new Tone.Synth({ volume: BEEP_VOLUME }).toDestination();
            }
        }
        // ユーザーの初回クリックでオーディオを有効化する
        document.body.addEventListener('click', initializeAudio, { once: true });

        /**
         * 短いビープ音（一時停止音など）を再生する。
         */
        function playShortBeep() {
            initializeAudio(); // 再生前に初期化されているか確認
            if (synth && Tone.context.state === 'running') {
                try {
                    // "G5"の音を0.1秒間再生
                    synth.triggerAttackRelease("G5", "0.1", Tone.now()); 
                } catch (e) {
                    console.error("Error playing short beep:", e);
                }
            }
        }

        /**
         * 長いビープ音（開始・終了音）を再生する。
         */
        function playLongBeep() {
            initializeAudio(); // 再生前に初期化されているか確認
            if (synth && Tone.context.state === 'running') {
                 try {
                    // "E5"の音を1.5秒間再生
                    synth.triggerAttackRelease("E5", "1.5", Tone.now()); 
                } catch (e) {
                    console.error("Error playing long beep:", e);
                }
            }
        }


        // ===================================================================================
        // --- Page Navigation & Display Control (ページの表示切り替え) ---
        // ===================================================================================
        
        /**
         * 指定されたページ要素だけを表示し、他のページはすべて非表示にする。
         * @param {HTMLElement} pageElement 表示したいページのコンテナ要素。
         */
        function showPage(pageElement) {
            // 全てのページコンテナを配列にまとめる
            const allPages = [universalTeamSelectionPage, ballArrangementPage, matchPlayPage, scoreInputPage, intermediateResultPage, resultsPage];
            allPages.forEach(p => {
                if (p) p.classList.add('hidden'); // 全てのページを一旦非表示に
            });
            if (pageElement) {
                pageElement.classList.remove('hidden'); // 指定されたページだけ表示
            }
            
            // 表示されるページに応じて「全体リセット」と「メインタイトル」の表示/非表示を切り替える
            if (fullResetButton && mainTitle) {
                if (pageElement === universalTeamSelectionPage) {
                    // 最初のページでのみ表示する
                    fullResetButton.classList.remove('hidden');
                    mainTitle.classList.remove('hidden');
                } else {
                    fullResetButton.classList.add('hidden');
                    mainTitle.classList.add('hidden');
                }
            }
        }

        /**
         * プルダウンメニュー（select要素）に選択肢（option）を動的に追加する汎用関数。
         * @param {HTMLSelectElement} selectElement - 対象のselect要素。
         * @param {number} max - 数字の選択肢を生成する場合の最大値。
         * @param {boolean} includeDefault - 「選択」というデフォルトの選択肢を含めるかどうか。
         * @param {Array|null} optionsArray - 文字列または{value, text}オブジェクトの配列で選択肢を指定。
         */
        function populateSelectWithOptions(selectElement, max, includeDefault = true, optionsArray = null) {
            if (!selectElement) return; 
            selectElement.innerHTML = ''; // 中身を一旦空にする
            if (includeDefault) {
                const defaultOption = new Option("選択", ""); // valueが空の「選択」を追加
                selectElement.add(defaultOption);
            }
            if (optionsArray) { // 配列から選択肢を生成
                optionsArray.forEach(opt => {
                    if (typeof opt === 'object' && opt.hasOwnProperty('value') && opt.hasOwnProperty('text')) { 
                        selectElement.add(new Option(opt.text, opt.value));
                    } else if (typeof opt === 'string') { 
                        selectElement.add(new Option(opt, opt));
                    }
                });
            } else { // 0からmaxまでの数字で選択肢を生成
                for (let i = 0; i <= max; i++) {
                    selectElement.add(new Option(i, i));
                }
            }
        }
        
        /**
         * スコア入力用のプルダウンメニュー（ボールの数）を初期化する。
         */
        function initializeScoreSelects() {
            populateSelectWithOptions(teamAOrangeBallsSelect, MAX_ORANGE_BALLS, true);
            populateSelectWithOptions(teamBOrangeBallsSelect, MAX_ORANGE_BALLS, true);
            populateSelectWithOptions(teamAPurpleBallsSelect, MAX_PURPLE_BALLS, true);
            populateSelectWithOptions(teamBPurpleBallsSelect, MAX_PURPLE_BALLS, true);
        }
        
        /**
         * 試合の手動終了理由を選択するプルダウンメニューを初期化する。
         */
        function initializeEndReasonSelects() {
            const endReasons = [];

            // 通常の終了理由
            const nonPenaltyReasons = [
                "コールド勝利(選択チームの勝利)",
                "その他両チームの合意(申し出たチームを選択・裁定に無関係)",
                "事故のロボット接触(6.28)", 
                "全ロボット行動不能(6.32.9)", 
                "オレンジボール5個以上10秒保持(6.30)"
            ];
            
            nonPenaltyReasons.forEach(reasonText => {
                let value = reasonText;
                // 特定の理由には短いvalueを設定
                if(reasonText.startsWith("コールド勝利")) {
                    value = "コールド勝利";
                } else if(reasonText.startsWith("その他両チームの合意")){
                    value = "その他両チームの合意";
                }
                 endReasons.push({ text: reasonText, value: value });
            });

            // 反則による終了理由
            PENALTY_FIXED_SCORE_REASONS.forEach(reason => {
                endReasons.push({
                    text: `[違反・自動敗北]${reason}`,
                    value: reason
                });
            });

            populateSelectWithOptions(endReasonSelect, 0, true, endReasons);
            if (endedByTeamSelect) endedByTeamSelect.value = "";
            if (endReasonSelect) endReasonSelect.value = "";
        }


        // ===================================================================================
        // --- Initialization and Resets (初期化とリセット処理) ---
        // ===================================================================================

        /**
         * チーム選択のUIをセットアップする。
         */
        function initializeTeamSelectionUI() { 
            // 動的に生成されたHTML要素を再度取得
            teamASelect = document.getElementById('teamASelectInternal');
            teamBSelect = document.getElementById('teamBSelectInternal');
            selectedTeamsDisplay = document.getElementById('selectedTeamsDisplayInternal');
            confirmTeamsButton = document.getElementById('confirmTeamsButtonInternal');

            if (!teamASelect || !teamBSelect || !selectedTeamsDisplay || !confirmTeamsButton) {
                console.error("Team selection dropdown elements not found.");
                return;
            }
            
            // ハードコードされたチームリストをプルダウンに設定
            populateSelectWithOptions(teamASelect, 0, true, teamListFromCsv); 
            populateSelectWithOptions(teamBSelect, 0, true, teamListFromCsv);

            // 表示を初期状態に戻す
            selectedTeamsDisplay.textContent = "チームを選択してください";
            confirmTeamsButton.disabled = true;
            teamASelect.disabled = false;
            teamBSelect.disabled = false;
            if(teamSelectDropdownsContainer) teamSelectDropdownsContainer.classList.remove('hidden');

             // イベントリスナーを設定
             teamASelect.addEventListener('change', handleTeamSelectionChange);
             teamBSelect.addEventListener('change', handleTeamSelectionChange);
             confirmTeamsButton.addEventListener('click', () => {
                const teamAOption = teamASelect.options[teamASelect.selectedIndex];
                const teamBOption = teamBSelect.options[teamBSelect.selectedIndex];

                // 選択されたチーム情報をグローバル変数に保存
                confirmedTeamA = teamAOption.value; 
                confirmedTeamADisplay = teamAOption.text; 
                confirmedTeamB = teamBOption.value;
                confirmedTeamBDisplay = teamBOption.text;

                // 選択後はプルダウンとボタンを無効化
                teamASelect.disabled = true; 
                teamBSelect.disabled = true;
                confirmTeamsButton.disabled = true; 
                
                // 最終結果表示ページのヘッダーもこの時点で更新しておく
                if(resultsHeaderTeamA) resultsHeaderTeamA.textContent = confirmedTeamADisplay;
                if(resultsHeaderTeamB) resultsHeaderTeamB.textContent = confirmedTeamBDisplay;

                // ボール配置表示ページへ進む
                displayBallArrangement();
            });
        }
        
        /**
         * マッチ固有のUIデータ（タイマー、ボタンの状態、入力欄など）をリセットする。
         * 新しいマッチを開始する際や、全体リセット時に呼ばれる。
         */
        function resetMatchSpecificUIData() {
            timeLeft = INITIAL_TIME_SECONDS;
            timerRunning = false;

            if (timerInterval) clearInterval(timerInterval); // 実行中のタイマーがあれば停止
            if(timerDisplay) {
                timerDisplay.textContent = formatTime(timeLeft);
                timerDisplay.classList.remove('timer-paused', 'timer-ended');
                timerDisplay.classList.add('timer-running'); 
            }
            
            // ボタンの表示・状態を「試合開始前」の状態に戻す
            if(timerControlsPreStart) timerControlsPreStart.classList.remove('hidden');
            if(timerControlsActive) timerControlsActive.classList.add('hidden');
            if(startButton) startButton.disabled = false; 
            if(startButtonActive) startButtonActive.disabled = true; 
            if(pauseButton) pauseButton.disabled = true;
            if(endMatchButton) endMatchButton.disabled = false; 
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
            
            // 終了理由の記録エリアを非表示＆リセット
            if(proceedToResultContainer) proceedToResultContainer.classList.add('hidden'); 
            if(endedByTeamSelect) {
                endedByTeamSelect.disabled = false;
                endReasonSelect.disabled = false;
                initializeEndReasonSelects();
            } 

            // 記録表示エリアをリセット
            if(recordDisplayOnTimerPage) {
                recordDisplayOnTimerPage.textContent = "記録待機中...";
                recordDisplayOnTimerPage.classList.remove('recorded');
            }

            // スコア入力欄をリセット（値は空、無効状態に）
            [teamAOrangeBallsSelect, teamBOrangeBallsSelect, teamAPurpleBallsSelect, teamBPurpleBallsSelect].forEach(sel => {
                if (sel) {
                    sel.value = ""; 
                    sel.disabled = true; 
                }
            });
            if(proceedToNextPhaseButton) proceedToNextPhaseButton.disabled = true;
        }

        /**
         * 新しいマッチを開始する準備をする。
         * @param {number} matchNum - 開始するマッチの番号 (1, 2, or 3)。
         */
        function setupNewMatch(matchNum) {
            currentMatchNumber = matchNum;
            // 各ページのタイトル表示を現在のマッチ番号に合わせて更新
            if(currentMatchDisplay) currentMatchDisplay.textContent = `第${currentMatchNumber}マッチ`;
            if(currentMatchTeamsDisplay) currentMatchTeamsDisplay.textContent = `${confirmedTeamADisplay} vs ${confirmedTeamBDisplay}`; 
            if(currentMatchScoreTitle) currentMatchScoreTitle.textContent = `第${currentMatchNumber}マッチ リザルト入力`; 
            
            resetMatchSpecificUIData(); // マッチのUIをリセット
            showPage(matchPlayPage); // マッチ進行ページを表示
        }

        /**
         * アプリケーション全体を完全に初期状態に戻す。
         */
        function fullApplicationReset() { 
            // 全てのゲーム状態を初期化
            currentMatchNumber = 1;
            matchesData = [];
            confirmedTeamA = "";
            confirmedTeamB = "";
            confirmedTeamADisplay = "";
            confirmedTeamBDisplay = "";
            
            resetMatchSpecificUIData(); 
            initializeScoreSelects(); 

            // チーム選択UIを直接初期化する
            initializeTeamSelectionUI();

            // 最初のチーム選択ページを表示
            showPage(universalTeamSelectionPage);
        }

        // ===================================================================================
        // --- Team Selection Logic (チーム選択のロジック) ---
        // ===================================================================================

        /**
         * チーム選択プルダウンが変更されたときに呼び出され、選択状態を検証する。
         */
        function handleTeamSelectionChange() {
            if (!teamASelect || !teamBSelect || !selectedTeamsDisplay || !confirmTeamsButton) return;
            const teamAVal = teamASelect.value; 
            const teamBVal = teamBSelect.value;
            const teamAText = teamASelect.options[teamASelect.selectedIndex].text;
            const teamBText = teamBSelect.options[teamBSelect.selectedIndex].text;

            if (teamAVal && teamBVal) { // 両方のチームが選択されている場合
                if (teamAVal === teamBVal) { // 同じチームが選択された場合
                    selectedTeamsDisplay.textContent = "異なるチームを選択してください";
                    selectedTeamsDisplay.style.color = "red";
                    confirmTeamsButton.disabled = true;
                } else { // 異なるチームが選択された場合
                    selectedTeamsDisplay.textContent = `${teamAText} vs ${teamBText}`;
                    selectedTeamsDisplay.style.color = "#1e40af";
                    confirmTeamsButton.disabled = false;
                }
            } else { // どちらか一方しか選択されていない場合
                selectedTeamsDisplay.textContent = "両方のチームを選択してください";
                selectedTeamsDisplay.style.color = "orange";
                confirmTeamsButton.disabled = true;
            }
        }

        // ===================================================================================
        // --- Ball Arrangement Logic (ボール配置のロジック) ---
        // ===================================================================================

        /**
         * ボールの初期配置をランダムに生成して表示する。
         * 左右のコートで点対称になるように配置する。
         */
        function displayBallArrangement() {
            if (!leftArrangementDiv || !rightArrangementDiv) return;

            // 前回の配置をクリア
            leftArrangementDiv.innerHTML = '<h3>左側</h3>';
            rightArrangementDiv.innerHTML = '<h3>右側</h3>';

            let leftArrangementData = [];
            // 4行のうち、紫ボールのペアがどの行に来るかをランダムに決める (0-3)
            const purplePairIndex = Math.floor(Math.random() * 4);

            // 左側の4行分の配置を生成
            for (let i = 0; i < 4; i++) {
                const orangeSide = Math.floor(Math.random() * 2); // 0 or 1 (左か右か)
                let purpleSide = -1; // 紫ボールがない場合は-1
                if (i === purplePairIndex) {
                    purpleSide = 1 - orangeSide; // オレンジボールの反対側に配置
                }
                leftArrangementData.push({ orange: orangeSide, purple: purpleSide });
            }

            // 生成したデータに基づいて左側のHTMLを構築
            leftArrangementData.forEach(pairData => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'circle-pair';
                for (let i = 0; i < 2; i++) {
                    const outerCircle = document.createElement('div');
                    outerCircle.className = 'outer-circle';
                    if (pairData.orange === i) {
                        const innerCircle = document.createElement('div');
                        innerCircle.className = 'inner-circle orange';
                        outerCircle.appendChild(innerCircle);
                    }
                    if (pairData.purple === i) {
                        const innerCircle = document.createElement('div');
                        innerCircle.className = 'inner-circle purple';
                        outerCircle.appendChild(innerCircle);
                    }
                    pairDiv.appendChild(outerCircle);
                }
                leftArrangementDiv.appendChild(pairDiv);
            });

            // 右側は左側を点対称にした配置を生成
            const rightArrangementData = [...leftArrangementData].reverse(); // 上下を反転
            rightArrangementData.forEach(pairData => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'circle-pair';
                for (let i = 0; i < 2; i++) {
                    const outerCircle = document.createElement('div');
                    outerCircle.className = 'outer-circle';
                    // 点対称にするため、左右の位置も反転させる (0 -> 1, 1 -> 0)
                    if (1 - pairData.orange === i) {
                        const innerCircle = document.createElement('div');
                        innerCircle.className = 'inner-circle orange';
                        outerCircle.appendChild(innerCircle);
                    }
                    if (pairData.purple !== -1 && (1 - pairData.purple) === i) {
                        const innerCircle = document.createElement('div');
                        innerCircle.className = 'inner-circle purple';
                        outerCircle.appendChild(innerCircle);
                    }
                    pairDiv.appendChild(outerCircle);
                }
                rightArrangementDiv.appendChild(pairDiv);
            });

            // 表示されるボタンのテキストを現在のマッチ番号に応じて変更する
            if (proceedToMatch1Button) {
                proceedToMatch1Button.textContent = `第${currentMatchNumber}マッチに進む`;
            }

            showPage(ballArrangementPage); // ボール配置ページを表示
        }

        // ===================================================================================
        // --- Timer Logic (タイマーのロジック) ---
        // ===================================================================================
        
        /**
         * 秒数を mm:ss 形式の文字列にフォーマットする。
         * @param {number} seconds - フォーマットする秒数。
         * @returns {string} フォーマットされた時間文字列 (例: "02:00")。
         */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            // String.padStart() を使って、1桁の数字の前に0を補完する (例: 5 -> "05")
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        /**
         * タイマーを開始する。
         */
        function startTimer() {
            if (timerRunning || timeLeft === 0) return; // 実行中または終了済みなら何もしない
            playLongBeep(); // 開始音
            timerRunning = true;
            
            // ボタンの状態を「実行中」モードに切り替え
            if(timerControlsPreStart) timerControlsPreStart.classList.add('hidden');
            if(timerControlsActive) timerControlsActive.classList.remove('hidden');
            if(startButtonActive) startButtonActive.disabled = true; 
            if(pauseButton) pauseButton.disabled = false;
            if(endMatchButton) endMatchButton.disabled = false; 
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
            if(timerDisplay) {
                timerDisplay.classList.remove('timer-paused', 'timer-ended');
                timerDisplay.classList.add('timer-running');
            }

            // 記録表示エリアを更新
            if(recordDisplayOnTimerPage) {
                recordDisplayOnTimerPage.textContent = "試合中...";
                recordDisplayOnTimerPage.classList.remove('recorded');
            }
             if(proceedToResultContainer) proceedToResultContainer.classList.add('hidden'); 

            // 1秒ごとに時間を減らす処理を開始
            timerInterval = setInterval(() => {
                timeLeft--;
                if(timerDisplay) timerDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) { // 0になったらタイマーを停止
                    clearInterval(timerInterval);
                    timerRunning = false;
                    timeLeft = 0;
                    if(timerDisplay) {
                        timerDisplay.textContent = formatTime(timeLeft);
                        timerDisplay.classList.remove('timer-running', 'timer-paused');
                        timerDisplay.classList.add('timer-ended');
                    }
                    playLongBeep(); // 終了音
                    handleMatchEnd(true); // isTimeout = true として試合終了処理を呼ぶ
                }
            }, 1000);
        }

        /**
         * タイマーを一時停止する。
         */
        function pauseTimer() {
            if (!timerRunning) return; // 実行中でなければ何もしない
            playShortBeep(); // 一時停止音
            clearInterval(timerInterval); // 時間の更新を止める
            timerRunning = false;

            // ボタンの状態を「一時停止中」モードに切り替え
            if(startButtonActive) startButtonActive.disabled = false; // 再開できるようにする
            if(pauseButton) pauseButton.disabled = true;
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = false; // リセットできるようにする
            if(timerDisplay) {
                timerDisplay.classList.remove('timer-running', 'timer-ended');
                timerDisplay.classList.add('timer-paused');
            }
            if(recordDisplayOnTimerPage) recordDisplayOnTimerPage.textContent = "一時停止中";
        }
        
        // 「試合手動終了」ボタンが押されたら確認モーダルを表示
        if(endMatchButton) endMatchButton.addEventListener('click', () => { 
            if(confirmationModal) confirmationModal.classList.remove('hidden');
        });

        // モーダルの「終了する」ボタンが押された時の処理
        if(confirmEndMatchButton) confirmEndMatchButton.addEventListener('click', () => {
            playLongBeep(); 
            if(confirmationModal) confirmationModal.classList.add('hidden');
            if (timerInterval) clearInterval(timerInterval); // タイマー停止
            timerRunning = false; 
            if(timerDisplay) {
                timerDisplay.classList.remove('timer-running', 'timer-paused');
                timerDisplay.classList.add('timer-ended');
            }
            handleMatchEnd(false); // isTimeout = false として試合終了処理を呼ぶ
        });

        // モーダルの「継続する」ボタンが押された時の処理
        if(cancelEndMatchButton) cancelEndMatchButton.addEventListener('click', () => {
            if(confirmationModal) confirmationModal.classList.add('hidden'); // モーダルを閉じるだけ
        });
        
        /**
         * 試合終了時の共通処理。タイムアウトか手動終了かで分岐する。
         * @param {boolean} isTimeout - trueならタイムアウト、falseなら手動終了。
         */
        function handleMatchEnd(isTimeout) {
            // ボタンを操作不能にする
            if(timerControlsPreStart) timerControlsPreStart.classList.add('hidden'); 
            if(timerControlsActive) timerControlsActive.classList.remove('hidden'); 
            if(startButtonActive) startButtonActive.disabled = true; 
            if(pauseButton) pauseButton.disabled = true;
            if(endMatchButton) endMatchButton.disabled = true; 
            if(resetMatchTimerButton) resetMatchTimerButton.disabled = true; 
            if(timerDisplay) { 
                timerDisplay.classList.remove('timer-running', 'timer-paused');
                timerDisplay.classList.add('timer-ended');
            }

            // このマッチのデータオブジェクトを初期化
            if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
            
            // どのタイプで終了したかを保存
            matchEndType = isTimeout ? 'timeout' : 'manual';

            // リザルト入力へ進むボタンを表示
            if(proceedToResultContainer) proceedToResultContainer.classList.remove('hidden');

            if (isTimeout) { // タイムアウトの場合
                if(recordDisplayOnTimerPage) {
                     recordDisplayOnTimerPage.textContent = "試合終了！リザルト入力へ進んでください。"; 
                     recordDisplayOnTimerPage.classList.add('recorded'); 
                }
            } else { // 手動終了の場合
                if(recordDisplayOnTimerPage) {
                    recordDisplayOnTimerPage.textContent = "試合手動終了。リザルト入力へ進んでください。"; 
                    recordDisplayOnTimerPage.classList.add('recorded');
                }
            }
        }
        
        /**
         * スコア入力ページのUIをセットアップする。
         * @param {string} endType - 'manual', 'timeout', または 'edit'
         */
        function setupScorePageUI(endType = 'timeout') { 
            const scoreSelects = [teamAOrangeBallsSelect, teamAPurpleBallsSelect, teamBOrangeBallsSelect, teamBPurpleBallsSelect];
            
            // 第2マッチではコートチェンジを考慮し、スコア入力欄のチーム名表示を入れ替える
            if (currentMatchNumber === 2) {
                if(scoreTeamAName) scoreTeamAName.textContent = confirmedTeamBDisplay; 
                if(scoreTeamBName) scoreTeamBName.textContent = confirmedTeamADisplay; 
            } else {
                if(scoreTeamAName) scoreTeamAName.textContent = confirmedTeamADisplay; 
                if(scoreTeamBName) scoreTeamBName.textContent = confirmedTeamBDisplay; 
            }

            // プルダウンをリセット
            scoreSelects.forEach(sel => {
                if(sel) sel.value = ""; 
            });

            // 終了タイプに応じてUIを制御
            if (manualEndReasonContainer) {
                if (endType === 'manual' || endType === 'edit') {
                    // 手動終了または編集モードの場合、理由選択エリアを表示
                    manualEndReasonContainer.classList.remove('hidden');
                    populateSelectWithOptions(endedByTeamSelect, 0, true, [
                        {text: confirmedTeamADisplay, value: confirmedTeamA},
                        {text: confirmedTeamBDisplay, value: confirmedTeamB}
                    ]);
                    initializeEndReasonSelects();
                    endedByTeamSelect.disabled = false;
                    endReasonSelect.disabled = false;
                    
                    if (endType === 'manual') {
                        // 新規の手動終了の場合、ボール数は入力不可
                        scoreSelects.forEach(sel => { if(sel) sel.disabled = true; });
                    } else { // 'edit'
                        // 編集の場合、ボール数を入力可能にする
                        scoreSelects.forEach(sel => { if(sel) sel.disabled = false; });
                    }
                     if(proceedToNextPhaseButton) proceedToNextPhaseButton.disabled = true;

                } else { // 'timeout'
                    // タイムアウトの場合、理由選択エリアは非表示
                    manualEndReasonContainer.classList.add('hidden');
                    scoreSelects.forEach(sel => { if(sel) sel.disabled = false; });
                    checkIfScoresAreComplete();
                }
            }

            // タイムアウトの場合、ステータスを先に設定
            if (endType === 'timeout') {
                 if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
                 matchesData[currentMatchNumber - 1].status = "タイムアップ";
                 matchesData[currentMatchNumber - 1].isColdGame = false;
                 matchesData[currentMatchNumber - 1].isPenaltyFixedScore = false;
            }
            
            showPage(scoreInputPage); // スコア入力ページを表示
        }
        
        /**
         * 手動終了の理由が選択されたときの処理。
         * 理由に応じてボール数入力欄の状態を制御し、データを保存する。
         */
        function checkManualEndReasonSelection() {
            if (endedByTeamSelect && endReasonSelect && endedByTeamSelect.value && endReasonSelect.value) {
                // 理由が選択されたら、関連データを保存
                const teamValue = endedByTeamSelect.value;
                const reasonOption = endReasonSelect.options[endReasonSelect.selectedIndex];
                const reasonValue = reasonOption.value;
                const teamText = endedByTeamSelect.options[endedByTeamSelect.selectedIndex].text;
                const statusText = `${teamText} - ${reasonValue}`;
                
                const isCold = (reasonValue === "コールド勝利");
                const isPenalty = PENALTY_FIXED_SCORE_REASONS.includes(reasonValue);

                if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
                matchesData[currentMatchNumber - 1].status = statusText;
                matchesData[currentMatchNumber - 1].isColdGame = isCold;
                matchesData[currentMatchNumber - 1].isPenaltyFixedScore = isPenalty;
                matchesData[currentMatchNumber - 1].penaltyLosingTeam = (isCold || isPenalty) ? teamValue : "";

                // 全てのボール数入力欄を有効化
                [teamAOrangeBallsSelect, teamAPurpleBallsSelect, teamBOrangeBallsSelect, teamBPurpleBallsSelect].forEach(sel => {
                    if (sel) sel.disabled = false;
                });
                
                // ★変更点: コールド勝利の場合、勝利チームのオレンジを0で固定し、両チームのオレンジ入力欄を無効化する
                if (isCold) {
                    const winningTeamValue = endedByTeamSelect.value;
                    let uiWinningOrangeSelect, uiLosingOrangeSelect;

                    // 第2マッチのコートチェンジを考慮
                    if (currentMatchNumber === 2) {
                        uiWinningOrangeSelect = (winningTeamValue === confirmedTeamB) ? teamAOrangeBallsSelect : teamBOrangeBallsSelect;
                        uiLosingOrangeSelect  = (winningTeamValue === confirmedTeamB) ? teamBOrangeBallsSelect : teamAOrangeBallsSelect;
                    } else { // Match 1 or 3
                        uiWinningOrangeSelect = (winningTeamValue === confirmedTeamA) ? teamAOrangeBallsSelect : teamBOrangeBallsSelect;
                        uiLosingOrangeSelect  = (winningTeamValue === confirmedTeamA) ? teamBOrangeBallsSelect : teamAOrangeBallsSelect;
                    }

                    // オレンジボールの数を設定して無効化
                    if (uiWinningOrangeSelect) {
                        uiWinningOrangeSelect.value = "0";
                        uiWinningOrangeSelect.disabled = true;
                    }
                    if (uiLosingOrangeSelect) {
                        uiLosingOrangeSelect.value = String(MAX_ORANGE_BALLS);
                        uiLosingOrangeSelect.disabled = true;
                    }
                }
                
                checkIfScoresAreComplete(); // 入力完了チェック
            } else {
                // 理由が未選択の状態に戻った場合、ボール数入力を無効化
                [teamAOrangeBallsSelect, teamAPurpleBallsSelect, teamBOrangeBallsSelect, teamBPurpleBallsSelect].forEach(sel => {
                    if(sel) {
                        sel.value = "";
                        sel.disabled = true;
                    }
                });
                if(proceedToNextPhaseButton) proceedToNextPhaseButton.disabled = true;
            }
        }
        
        // ===================================================================================
        // --- Score Input Logic (スコア入力のロジック) ---
        // ===================================================================================

        /**
         * 片方のボール数を入力すると、もう片方のチームのボール数が自動で入力される処理。
         * @param {HTMLSelectElement} sourceSelect - 入力元のselect要素。
         * @param {HTMLSelectElement} targetSelect - 自動入力先のselect要素。
         * @param {number} maxTotal - ボールの合計最大数。
         */
        function handleScoreSelectChange(sourceSelect, targetSelect, maxTotal) {
            if (!sourceSelect || !targetSelect) return;
            if (!sourceSelect.disabled) { // 無効化されていなければ処理
                const sourceValue = parseInt(sourceSelect.value);
                if (!isNaN(sourceValue) && sourceValue >= 0 && sourceValue <= maxTotal) { 
                    targetSelect.value = maxTotal - sourceValue;
                } else { 
                    targetSelect.value = ""; // 不正な値の場合はリセット
                }
            }
            checkIfScoresAreComplete(); // 入力が完了したかチェック
        }

        /**
         * 全てのスコアが入力されたかチェックし、「確定」ボタンの有効/無効を切り替える。
         * 入力が完了していれば、`matchesData`にスコアを保存する。
         */
        function checkIfScoresAreComplete() {
            const currentMatchRecord = matchesData[currentMatchNumber - 1] || {};
            const valuesToValidate = [];

            valuesToValidate.push(
                teamAOrangeBallsSelect?.value, teamAPurpleBallsSelect?.value,
                teamBOrangeBallsSelect?.value, teamBPurpleBallsSelect?.value
            );
            
            // 全ての値が選択済み（空文字や初期値でない）か
            const allSelected = valuesToValidate.every(val => val && val !== "");
            if(proceedToNextPhaseButton) proceedToNextPhaseButton.disabled = !allSelected;

            // 全て選択されていたら、データを保存
            if(allSelected) { 
                if (!matchesData[currentMatchNumber - 1]) matchesData[currentMatchNumber - 1] = {};
                
                let uiOrangeLeftVal = parseInt(teamAOrangeBallsSelect.value);
                let uiPurpleLeftVal = parseInt(teamAPurpleBallsSelect.value);
                let uiOrangeRightVal = parseInt(teamBOrangeBallsSelect.value);
                let uiPurpleRightVal = parseInt(teamBPurpleBallsSelect.value);

                // 第2マッチのコートチェンジを考慮して正しいチームにデータを保存
                if (currentMatchNumber === 2) {
                    matchesData[currentMatchNumber - 1].teamB_Orange = uiOrangeLeftVal;
                    matchesData[currentMatchNumber - 1].teamB_Purple = uiPurpleLeftVal;
                    matchesData[currentMatchNumber - 1].teamA_Orange = uiOrangeRightVal;
                    matchesData[currentMatchNumber - 1].teamA_Purple = uiPurpleRightVal;
                } else {
                    matchesData[currentMatchNumber - 1].teamA_Orange = uiOrangeLeftVal;
                    matchesData[currentMatchNumber - 1].teamA_Purple = uiPurpleLeftVal;
                    matchesData[currentMatchNumber - 1].teamB_Orange = uiOrangeRightVal;
                    matchesData[currentMatchNumber - 1].teamB_Purple = uiPurpleRightVal;
                }
            }
        }

        // ===================================================================================
        // --- Intermediate Result Page Logic (中間結果ページのロジック) ---
        // ===================================================================================

        /**
         * マッチごとの結果を表示する。
         * @param {number} matchIndex - 表示するマッチのインデックス (0, 1, or 2)。
         */
        function displayIntermediateResult(matchIndex) {
            const match = matchesData[matchIndex];
            if (!match || !intermediateResultPage) return;

            // ヘッダー情報を更新
            if(intermediateResultTitle) intermediateResultTitle.textContent = `第${matchIndex + 1}マッチ 結果`;
            if(intermediateMatchTeams) intermediateMatchTeams.textContent = `${confirmedTeamADisplay} vs ${confirmedTeamBDisplay}`;
            
            if(intermediateMatchResultTableBody) intermediateMatchResultTableBody.innerHTML = ''; // テーブルの中身をクリア

            // このマッチのスコアを計算
            let teamAScoreIntermediate, teamBScoreIntermediate;
            let teamAOrangeIntermediate = match.teamA_Orange;
            let teamAPurpleIntermediate = match.teamA_Purple;
            let teamBOrangeIntermediate = match.teamB_Orange;
            let teamBPurpleIntermediate = match.teamB_Purple;

            if (match.isPenaltyFixedScore) {
                // 反則の場合は点数が逆になる
                if (match.penaltyLosingTeam === confirmedTeamA) { teamAScoreIntermediate = 8; teamBScoreIntermediate = -4; }
                else { teamAScoreIntermediate = -4; teamBScoreIntermediate = 8; }
            } else {
                 // 通常の得点計算 (オレンジボール1点、紫ボール-2点)
                 // コールド勝利の場合もこの計算が適用される
                teamAScoreIntermediate = teamAOrangeIntermediate - (teamAPurpleIntermediate * 2);
                teamBScoreIntermediate = teamBOrangeIntermediate - (teamBPurpleIntermediate * 2);
            }
            
            // 勝者を判定し、matchオブジェクトに保存
            match.winner = null; 
            if (teamAScoreIntermediate < teamBScoreIntermediate) {
                match.winner = confirmedTeamA;
            } else if (teamBScoreIntermediate < teamAScoreIntermediate) {
                match.winner = confirmedTeamB;
            } else {
                match.winner = "draw";
            }

            // テーブルに行を追加して結果を表示
            const rowA = intermediateMatchResultTableBody.insertRow();
            rowA.insertCell().textContent = confirmedTeamADisplay;
            rowA.insertCell().textContent = teamAOrangeIntermediate ?? "-";
            rowA.insertCell().textContent = teamAPurpleIntermediate ?? "-"; 
            rowA.insertCell().textContent = teamAScoreIntermediate ?? "-";

            const rowB = intermediateMatchResultTableBody.insertRow();
            rowB.insertCell().textContent = confirmedTeamBDisplay;
            rowB.insertCell().textContent = teamBOrangeIntermediate ?? "-";
            rowB.insertCell().textContent = teamBPurpleIntermediate ?? "-"; 
            rowB.insertCell().textContent = teamBScoreIntermediate ?? "-";

            // 勝敗に応じてセルのスタイルを変更
            const cellsToHighlightAInter = Array.from(rowA.cells).slice(1);
            const cellsToHighlightBInter = Array.from(rowB.cells).slice(1);
            cellsToHighlightAInter.forEach(cell => cell.className = '');
            cellsToHighlightBInter.forEach(cell => cell.className = '');
            
            const matchStatusText = `[${match.status || "未記録"}]`;

            if (match.winner === confirmedTeamA) {
                cellsToHighlightAInter.forEach(cell => cell.classList.add('highlight-winner-cell'));
                if(intermediateMatchWinnerDisplay) {
                    intermediateMatchWinnerDisplay.textContent = `勝者:${matchStatusText} ${confirmedTeamADisplay}`;
                    intermediateMatchWinnerDisplay.style.color = 'green';
                }
            } else if (match.winner === confirmedTeamB) {
                cellsToHighlightBInter.forEach(cell => cell.classList.add('highlight-winner-cell'));
                if(intermediateMatchWinnerDisplay) {
                    intermediateMatchWinnerDisplay.textContent = `勝者:${matchStatusText} ${confirmedTeamBDisplay}`;
                    intermediateMatchWinnerDisplay.style.color = 'green';
                }
            } else if (match.winner === "draw") {
                cellsToHighlightAInter.forEach(cell => cell.classList.add('highlight-draw-cell'));
                cellsToHighlightBInter.forEach(cell => cell.classList.add('highlight-draw-cell'));
                if(intermediateMatchWinnerDisplay) {
                    intermediateMatchWinnerDisplay.textContent = "引き分け";
                    intermediateMatchWinnerDisplay.style.color = 'red';
                }
            }

            // 「次へ」ボタンのテキストを、現在のマッチ番号に応じて変更
            if(goToNextStepButton) {
                if (currentMatchNumber < TOTAL_MATCHES) {
                    // 第1、第2マッチ終了後
                    goToNextStepButton.textContent = `第${currentMatchNumber + 1}マッチのボール配置を表示`;
                } else {
                    // 最終マッチ終了後
                    goToNextStepButton.textContent = "総合結果へ";
                }
            }
            if(editMatchResultButton) {
                editMatchResultButton.textContent = `第${matchIndex + 1}マッチのリザルトを変更`;
            }
            showPage(intermediateResultPage); // 中間結果ページを表示
        }
        
        // ===================================================================================
        // --- Results Page Logic (最終結果ページのロジック) ---
        // ===================================================================================

        /**
         * 3マッチ全ての総合結果を表示する。
         */
        function displayResults() {
            if(!resultsPage) return;
            if(resultsTeamsDisplay) resultsTeamsDisplay.textContent = `${confirmedTeamADisplay} vs ${confirmedTeamBDisplay}`;
            if(resultsTableBody) resultsTableBody.innerHTML = ''; 
            
            // 各種集計用の変数を初期化
            let gameTotalWinsTeamA = 0;
            let gameTotalWinsTeamB = 0;
            let gameTotalFoulsTeamA = 0;
            let gameTotalFoulsTeamB = 0;
            let gameTotalOrangeBallsTeamA = 0;
            let gameTotalPurpleBallsTeamA = 0;
            let gameTotalOrangeBallsTeamB = 0;
            let gameTotalPurpleBallsTeamB = 0;
            // ★変更点: マッチごとの得点を合計するための変数を追加
            let gameTotalScoreTeamA = 0;
            let gameTotalScoreTeamB = 0;


            // 3マッチ分のデータをループして集計 & テーブル描画
            for (let i = 0; i < TOTAL_MATCHES; i++) {
                const match = matchesData[i] || {}; 
                if(!resultsTableBody) continue;
                const row = resultsTableBody.insertRow();
                
                // 違反回数を集計
                if (match.isPenaltyFixedScore === true) { 
                    if (match.penaltyLosingTeam === confirmedTeamA) {
                        gameTotalFoulsTeamA++;
                    } else if (match.penaltyLosingTeam === confirmedTeamB) {
                        gameTotalFoulsTeamB++;
                    }
                }

                // ボール数とスコアを計算・集計
                let teamAOrange = match.teamA_Orange;
                let teamAPurple = match.teamA_Purple;
                let teamAScore = null;
                let teamBOrange = match.teamB_Orange;
                let teamBPurple = match.teamB_Purple;
                let teamBScore = null;

                if (teamAOrange !== undefined) gameTotalOrangeBallsTeamA += teamAOrange;
                if (teamAPurple !== undefined) gameTotalPurpleBallsTeamA += teamAPurple;
                if (teamBOrange !== undefined) gameTotalOrangeBallsTeamB += teamBOrange;
                if (teamBPurple !== undefined) gameTotalPurpleBallsTeamB += teamBPurple;

                if (match.isPenaltyFixedScore) { 
                    if (match.penaltyLosingTeam === confirmedTeamA) { teamAScore = 8; teamBScore = -4; } 
                    else if (match.penaltyLosingTeam === confirmedTeamB) { teamAScore = -4; teamBScore = 8; }
                } else { 
                    // 通常の得点計算 (オレンジボール1点、紫ボール-2点)
                    // コールド勝利の場合もこの計算が適用される
                    if (teamAOrange !== undefined && teamAPurple !== undefined) { teamAScore = teamAOrange - (teamAPurple * 2); }
                    if (teamBOrange !== undefined && teamBPurple !== undefined) { teamBScore = teamBOrange - (teamBPurple * 2); }
                }
                
                // ★変更点: 各マッチのスコアを合計に加算
                if (teamAScore !== null) gameTotalScoreTeamA += teamAScore;
                if (teamBScore !== null) gameTotalScoreTeamB += teamBScore;

                // 勝利数を集計
                if (match.winner === confirmedTeamA) { gameTotalWinsTeamA++; }
                else if (match.winner === confirmedTeamB) { gameTotalWinsTeamB++; }

                // テーブルの各セルを埋める
                row.insertCell().textContent = `第${i + 1}マッチ`;
                row.insertCell().textContent = match.status || "未記録";
                const cellAOrange = row.insertCell(); cellAOrange.textContent = teamAOrange ?? "-";
                const cellAPurple = row.insertCell(); cellAPurple.textContent = teamAPurple ?? "-";
                const cellAScore = row.insertCell(); cellAScore.textContent = teamAScore ?? "-";
                const cellBOrange = row.insertCell(); cellBOrange.textContent = teamBOrange ?? "-";
                const cellBPurple = row.insertCell(); cellBPurple.textContent = teamBPurple ?? "-";
                const cellBScore = row.insertCell(); cellBScore.textContent = teamBScore ?? "-";

                // 勝敗に応じてセルをハイライト
                const cellsToHighlightA = [cellAOrange, cellAPurple, cellAScore];
                const cellsToHighlightB = [cellBOrange, cellBPurple, cellBScore];
                if (match.winner === confirmedTeamA) {
                    cellsToHighlightA.forEach(cell => cell.classList.add('highlight-winner-cell'));
                } else if (match.winner === confirmedTeamB) {
                    cellsToHighlightB.forEach(cell => cell.classList.add('highlight-winner-cell'));
                } else if (match.winner === "draw") {
                    cellsToHighlightA.forEach(cell => cell.classList.add('highlight-draw-cell'));
                    cellsToHighlightB.forEach(cell => cell.classList.add('highlight-draw-cell'));
                }
            }

            // 総合勝者を判定する
            let overallWinner = null;
            let overallDraw = false;
            let winReasonText = "";

            // 判定ロジック: 1. 勝利マッチ数 -> 2. 総違反回数(少ない方) -> 3. 総ボールスコア(高い方)
            if (gameTotalWinsTeamA > gameTotalWinsTeamB) {
                overallWinner = confirmedTeamADisplay;
                winReasonText = "[勝利マッチ数]";
            } else if (gameTotalWinsTeamB > gameTotalWinsTeamA) {
                overallWinner = confirmedTeamBDisplay;
                winReasonText = "[勝利マッチ数]";
            } else { // 勝利数が同じ場合
                if (gameTotalFoulsTeamA < gameTotalFoulsTeamB) {
                    overallWinner = confirmedTeamADisplay;
                    winReasonText = "[総違反回数]";
                } else if (gameTotalFoulsTeamB < gameTotalFoulsTeamA) {
                    overallWinner = confirmedTeamBDisplay;
                    winReasonText = "[総違反回数]";
                } else { // 違反回数も同じ場合
                    // ★変更点: 総合スコアの判定を、合計したマッチごとの得点で行う
                    if (gameTotalScoreTeamA < gameTotalScoreTeamB) { // スコアは小さい方が勝ち
                        overallWinner = confirmedTeamADisplay;
                        winReasonText = "[総ボールスコア]";
                    } else if (gameTotalScoreTeamB < gameTotalScoreTeamA) {
                        overallWinner = confirmedTeamBDisplay;
                        winReasonText = "[総ボールスコア]";
                    } else { // スコアも同じ場合は引き分け
                        overallDraw = true;
                    }
                }
            }

            // 集計結果テーブルをHTMLで構築して表示
            if (summaryStatsContainer) {
                summaryStatsContainer.innerHTML = `
                    <h3 class="font-bold mb-2 mt-4 text-xl">総計</h3>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>チーム</th>
                                <th>勝利マッチ数</th>
                                <th>総違反回数</th>
                                <th>総オレンジ</th>
                                <th>総紫</th>
                                <th>総ボールスコア</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="summaryRowTeamA">
                                <td id="summaryNameTeamA">${confirmedTeamADisplay}</td>
                                <td>${gameTotalWinsTeamA}</td>
                                <td>${gameTotalFoulsTeamA}</td>
                                <td>${gameTotalOrangeBallsTeamA}</td>
                                <td>${gameTotalPurpleBallsTeamA}</td>
                                <!-- ★変更点: 表示するスコアを、合計したマッチごとの得点に変更 -->
                                <td>${gameTotalScoreTeamA}</td>
                            </tr>
                            <tr id="summaryRowTeamB">
                                <td id="summaryNameTeamB">${confirmedTeamBDisplay}</td>
                                <td>${gameTotalWinsTeamB}</td>
                                <td>${gameTotalFoulsTeamB}</td>
                                <td>${gameTotalOrangeBallsTeamB}</td>
                                <td>${gameTotalPurpleBallsTeamB}</td>
                                <!-- ★変更点: 表示するスコアを、合計したマッチごとの得点に変更 -->
                                <td>${gameTotalScoreTeamB}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
                // 勝者や引き分けに応じてハイライトを適用
                const summaryRowTeamA = document.getElementById('summaryRowTeamA');
                const summaryRowTeamB = document.getElementById('summaryRowTeamB');
                const summaryNameTeamA = document.getElementById('summaryNameTeamA');
                const summaryNameTeamB = document.getElementById('summaryNameTeamB');

                if (overallWinner === confirmedTeamADisplay && summaryRowTeamA) {
                    summaryRowTeamA.classList.add('overall-winner-row');
                } else if (overallWinner === confirmedTeamBDisplay && summaryRowTeamB) {
                    summaryRowTeamB.classList.add('overall-winner-row');
                } else if (overallDraw && summaryNameTeamA && summaryNameTeamB) {
                    summaryNameTeamA.classList.add('overall-draw-team-name');
                    summaryNameTeamB.classList.add('overall-draw-team-name');
                }
            }
            
            // 総合結果のテキストを表示
            if(overallWinnerDisplay) {
                if (overallWinner) {
                    overallWinnerDisplay.textContent = `総合結果:${winReasonText} ${overallWinner}の勝利！`; 
                    overallWinnerDisplay.style.color = 'green';
                } else if (overallDraw) {
                    overallWinnerDisplay.textContent = "総合結果:引き分け！"; 
                    overallWinnerDisplay.style.color = 'red';
                } else {
                    overallWinnerDisplay.textContent = ""; 
                }
            }

            showPage(resultsPage); // 最終結果ページを表示
        }
        
        // ===================================================================================
        // --- Initial Setup (初期設定) ---
        // ===================================================================================

        /**
         * アプリケーションのUI部品（ページコンテナの中身）を動的に生成し、HTMLに挿入する。
         * これにより、初期HTMLをシンプルに保つことができる。
         */
        function injectMissingHTML() {
            // ★変更点: CSVアップロード機能を削除し、チーム選択のみのHTMLを挿入
            if (universalTeamSelectionPage && universalTeamSelectionPage.children.length === 0) {
                 const teamSelectionHTML = `
                    <div class="team-selection-container">
                        <h2 class="section-title">対戦チーム選択</h2>
                        <div id="teamSelectDropdownsContainer">
                            <div class="team-select-group">
                                <label for="teamASelectInternal">審判左手:</label>
                                <select id="teamASelectInternal"><option value="">チームを選択</option></select>
                                <span class="mx-2 font-bold">vs</span>
                                <label for="teamBSelectInternal">審判右手:</label>
                                <select id="teamBSelectInternal"><option value="">チームを選択</option></select>
                            </div>
                            <div id="selectedTeamsDisplayInternal">チームを選択してください</div>
                            <button id="confirmTeamsButtonInternal" class="btn btn-primary mt-4" disabled>第1マッチのボール配置を表示</button>
                        </div>
                    </div>`;
                universalTeamSelectionPage.innerHTML = teamSelectionHTML;
                teamSelectDropdownsContainer = document.getElementById('teamSelectDropdownsContainer');
            }
            // スコア入力ページの中身が空の場合にHTMLを挿入
            if (scoreInputPage && scoreInputPage.children.length === 0) {
                const scoreInputHTML = `
                    <div class="score-input-page-container">
                        <div id="currentMatchScoreTitleInternal" class="match-title-display">第Xマッチ リザルト入力</div>
                        
                        <div id="manualEndReasonContainer" class="hidden">
                            <h2 class="section-title">終了理由</h2> 
                            <div class="team-select-group">
                                <label for="endedByTeamSelectInternal" class="mr-2">対象チーム:</label>
                                <select id="endedByTeamSelectInternal" class="flex-grow"></select>
                            </div>
                            <div class="team-select-group mt-3">
                                <label for="endReasonSelectInternal" class="mr-2">理由:</label>
                                <select id="endReasonSelectInternal" class="flex-grow"></select>
                            </div>
                        </div>

                        <h2 class="section-title mt-4">ボール数</h2>

                        <div class="score-input-area">
                            <div class="score-team-section">
                                <h3 id="scoreTeamANameInternal">チームA</h3>
                                <div class="score-input-group">
                                    <label for="teamAOrangeBallsSelectInternal">オレンジボール (0-8):</label>
                                    <select id="teamAOrangeBallsSelectInternal" disabled></select>
                                </div>
                                <div class="score-input-group">
                                    <label for="teamAPurpleBallsSelectInternal">紫ボール (0-2):</label>
                                    <select id="teamAPurpleBallsSelectInternal" disabled></select>
                                </div>
                            </div>
                            <div class="score-team-section">
                                <h3 id="scoreTeamBNameInternal">チームB</h3>
                                <div class="score-input-group">
                                    <label for="teamBOrangeBallsSelectInternal">オレンジボール (0-8):</label>
                                    <select id="teamBOrangeBallsSelectInternal" disabled></select>
                                </div>
                                <div class="score-input-group">
                                    <label for="teamBPurpleBallsSelectInternal">紫ボール (0-2):</label>
                                    <select id="teamBPurpleBallsSelectInternal" disabled></select>
                                </div>
                            </div>
                        </div>
                        <div class="next-match-btn-container">
                            <button id="proceedToNextPhaseButtonInternal" class="btn btn-primary" disabled>確定</button>
                        </div>
                    </div>`;
                scoreInputPage.innerHTML = scoreInputHTML;
            }
        }

        /**
         * injectMissingHTML()で動的に生成された要素を変数に再割り当てし、イベントリスナーを設定する。
         * ページ読み込み時とHTML注入後に実行する必要がある。
         */
        function reassignDynamicPageElements() {
            // スコア入力ページの要素を取得
            currentMatchScoreTitle = document.getElementById('currentMatchScoreTitleInternal');
            scoreTeamAName = document.getElementById('scoreTeamANameInternal');
            teamAOrangeBallsSelect = document.getElementById('teamAOrangeBallsSelectInternal');
            teamAPurpleBallsSelect = document.getElementById('teamAPurpleBallsSelectInternal');
            scoreTeamBName = document.getElementById('scoreTeamBNameInternal');
            teamBOrangeBallsSelect = document.getElementById('teamBOrangeBallsSelectInternal');
            teamBPurpleBallsSelect = document.getElementById('teamBPurpleBallsSelectInternal');
            proceedToNextPhaseButton = document.getElementById('proceedToNextPhaseButtonInternal');
            manualEndReasonContainer = document.getElementById('manualEndReasonContainer');
            endedByTeamSelect = document.getElementById('endedByTeamSelectInternal');
            endReasonSelect = document.getElementById('endReasonSelectInternal');
            
            // 中間結果ページの要素を取得
            intermediateResultTitle = document.getElementById('intermediateResultTitle');
            intermediateMatchTeams = document.getElementById('intermediateMatchTeams');
            intermediateMatchStatusDisplay = document.getElementById('intermediateMatchStatusDisplay');
            intermediateMatchResultTableBody = document.getElementById('intermediateMatchResultTableBody');
            intermediateMatchWinnerDisplay = document.getElementById('intermediateMatchWinnerDisplay');
            goToNextStepButton = document.getElementById('goToNextStepButton');
            editMatchResultButton = document.getElementById('editMatchResultButton');

            // 再取得した要素にイベントリスナーを設定
            if(teamAOrangeBallsSelect) teamAOrangeBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamAOrangeBallsSelect, teamBOrangeBallsSelect, MAX_ORANGE_BALLS));
            if(teamBOrangeBallsSelect) teamBOrangeBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamBOrangeBallsSelect, teamAOrangeBallsSelect, MAX_ORANGE_BALLS));
            if(teamAPurpleBallsSelect) teamAPurpleBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamAPurpleBallsSelect, teamBPurpleBallsSelect, MAX_PURPLE_BALLS));
            if(teamBPurpleBallsSelect) teamBPurpleBallsSelect.addEventListener('change', () => handleScoreSelectChange(teamBPurpleBallsSelect, teamAPurpleBallsSelect, MAX_PURPLE_BALLS));
            
            if(proceedToNextPhaseButton) {
                proceedToNextPhaseButton.addEventListener('click', () => {
                    displayIntermediateResult(currentMatchNumber - 1);
                });
            }
            if(goToNextStepButton) {
                // 第1、第2マッチ終了後はボール配置表示へ、第3マッチ後は総合結果へ
                goToNextStepButton.addEventListener('click', () => {
                    if (currentMatchNumber < TOTAL_MATCHES) { // マッチ1, 2の後に実行
                        currentMatchNumber++; // マッチ番号を次に進める (2 or 3)
                        displayBallArrangement(); // 次のマッチのボール配置を表示
                    } else { // マッチ3の後に実行
                        displayResults();
                    }
                });
            }
            if(editMatchResultButton) {
                // 「リザルトを変更」ボタンの処理
                editMatchResultButton.addEventListener('click', () => {
                    setupScorePageUI('edit'); // 編集モードでスコアページを開く
                    const match = matchesData[currentMatchNumber - 1];
                    if (!match) return;

                    // 以前の理由を復元
                    if (match.status && match.status !== 'タイムアップ') {
                        // status "チーム名 - 理由" をパースする
                        const statusParts = match.status.split(' - ');
                        const teamDisplayText = statusParts[0];
                        const reasonValue = statusParts.slice(1).join(' - ');

                        if (teamDisplayText === confirmedTeamADisplay) {
                            endedByTeamSelect.value = confirmedTeamA;
                        } else if (teamDisplayText === confirmedTeamBDisplay) {
                            endedByTeamSelect.value = confirmedTeamB;
                        }
                        endReasonSelect.value = reasonValue;
                    }
                    
                    // 以前のボール数を復元 (第2マッチのコートチェンジを考慮)
                    if (currentMatchNumber === 2) { 
                        teamAOrangeBallsSelect.value = match.teamB_Orange ?? "";
                        teamAPurpleBallsSelect.value = match.teamB_Purple ?? "";
                        teamBOrangeBallsSelect.value = match.teamA_Orange ?? "";
                        teamBPurpleBallsSelect.value = match.teamA_Purple ?? "";
                    } else {
                        teamAOrangeBallsSelect.value = match.teamA_Orange ?? "";
                        teamAPurpleBallsSelect.value = match.teamA_Purple ?? "";
                        teamBOrangeBallsSelect.value = match.teamB_Orange ?? "";
                        teamBPurpleBallsSelect.value = match.teamB_Purple ?? "";
                    }
                    
                    // ★変更点: コールドゲームの場合、オレンジボールの入力欄を無効化する
                    if (match.isColdGame) {
                        const winningTeamValue = match.penaltyLosingTeam;
                        let uiWinningOrangeSelect, uiLosingOrangeSelect;
                        if (currentMatchNumber === 2) {
                            uiWinningOrangeSelect = (winningTeamValue === confirmedTeamB) ? teamAOrangeBallsSelect : teamBOrangeBallsSelect;
                            uiLosingOrangeSelect  = (winningTeamValue === confirmedTeamB) ? teamBOrangeBallsSelect : teamAOrangeBallsSelect;
                        } else {
                            uiWinningOrangeSelect = (winningTeamValue === confirmedTeamA) ? teamAOrangeBallsSelect : teamBOrangeBallsSelect;
                            uiLosingOrangeSelect  = (winningTeamValue === confirmedTeamA) ? teamBOrangeBallsSelect : teamAOrangeBallsSelect;
                        }
                        if (uiWinningOrangeSelect) uiWinningOrangeSelect.disabled = true;
                        if (uiLosingOrangeSelect) uiLosingOrangeSelect.disabled = true;
                    }
                    
                    checkIfScoresAreComplete(); // 状態を再チェック
                });
            }
            
             // 手動終了の理由選択時のイベントリスナー
             if(endedByTeamSelect) endedByTeamSelect.addEventListener('change', checkManualEndReasonSelection);
             if(endReasonSelect) endReasonSelect.addEventListener('change', checkManualEndReasonSelection);

            // 最終結果ページの要素とイベントリスナー
            resultsTeamsDisplay = document.getElementById('resultsTeamsDisplay');
            resultsHeaderTeamA = document.getElementById('resultsHeaderTeamA');
            resultsHeaderTeamB = document.getElementById('resultsHeaderTeamB');
            resultsTableBody = document.getElementById('resultsTableBody');
            startNewGameButton = document.getElementById('startNewGameButton');
            summaryStatsContainer = document.getElementById('summaryStatsContainer'); 
            overallWinnerDisplay = document.getElementById('overallWinnerDisplay');
            if(startNewGameButton) {
                // ★変更点: 新しい試合の開始処理を簡略化
                startNewGameButton.addEventListener('click', fullApplicationReset);
            }
        }


        /**
         * ページの読み込みが完了したときに実行される処理。
         * アプリケーションの起点となる。
         */
        window.onload = () => {
            // 1. HTML部品を注入
            injectMissingHTML(); 
            // 2. 動的に生成された要素も含む、全ての要素を取得＆イベント設定
            reassignDynamicPageElements(); 

            // 3. 静的な要素にイベントリスナーを設定
            if(startButton) startButton.addEventListener('click', startTimer);
            if(startButtonActive) startButtonActive.addEventListener('click', startTimer); 
            if(pauseButton) pauseButton.addEventListener('click', pauseTimer);
            if(fullResetButton) fullResetButton.addEventListener('click', fullApplicationReset);
            
            if(resetMatchTimerButton) {
                resetMatchTimerButton.addEventListener('click', () => {
                    playShortBeep();
                    if (timerInterval) clearInterval(timerInterval);
                    timeLeft = INITIAL_TIME_SECONDS;
                    timerRunning = false;
                    if(timerDisplay) {
                        timerDisplay.textContent = formatTime(timeLeft);
                        timerDisplay.classList.remove('timer-paused', 'timer-ended');
                        timerDisplay.classList.add('timer-running');
                    }
                    // ボタンの状態を一時停止中に戻す
                    if(timerControlsActive && !timerControlsActive.classList.contains('hidden')) {
                        if(startButtonActive) startButtonActive.disabled = false;
                        if(pauseButton) pauseButton.disabled = true;
                        if(endMatchButton) endMatchButton.disabled = false;
                        if(resetMatchTimerButton) resetMatchTimerButton.disabled = true;
                    }
                    if(proceedToResultContainer) proceedToResultContainer.classList.add('hidden');
                    if(recordDisplayOnTimerPage) {
                        recordDisplayOnTimerPage.textContent = "記録待機中...";
                        recordDisplayOnTimerPage.classList.remove('recorded');
                    }
                });
            }
            
            // ボール配置画面のボタンは、現在のマッチ番号に応じた試合を開始する
            if(proceedToMatch1Button) {
                proceedToMatch1Button.addEventListener('click', () => {
                    setupNewMatch(currentMatchNumber);
                });
            }
            
            // 「リザルト入力へ進む」ボタンの処理
            if(proceedToResultButton) {
                proceedToResultButton.addEventListener('click', () => {
                    setupScorePageUI(matchEndType);
                });
            }

            // モバイル端末でプルダウンを操作した際に、背景がスクロールしてしまうのを防ぐ
            const allSelects = document.querySelectorAll('select');
            allSelects.forEach(select => {
                select.addEventListener('touchmove', (event) => {
                    event.stopPropagation();
                });
            });

            // 全画面表示ボタンのイベントリスナーを追加
            if (fullscreenButton) {
                fullscreenButton.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        });
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                });
            }
            // 全画面の状態が変わったときにボタンのテキストを変更
            document.addEventListener('fullscreenchange', () => {
                if(fullscreenButton) {
                    if (document.fullscreenElement) {
                        fullscreenButton.textContent = '全画面表示を終了';
                    } else {
                        fullscreenButton.textContent = '全画面表示';
                    }
                }
            });
            
            // 4. アプリケーションを初期状態にする
            fullApplicationReset(); 
        };
    </script>
</body>
</html>
